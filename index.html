<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3è¡Œã‚¢ãƒ—ãƒªé–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#1f5eff" />
  <style>
    :root{
      --bg:#f3f6ff;
      --blue:#1f5eff;
      --blue2:#2a6cff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e6eefc;
      --shadow:0 18px 40px rgba(15, 23, 42, .10);
      --radius:18px;
      --danger:#ff4d4f;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:var(--bg);color:var(--text)}
    header{
      background: radial-gradient(1200px 500px at 15% 20%, rgba(255,255,255,.18), transparent 60%),
                  radial-gradient(800px 400px at 80% 10%, rgba(255,255,255,.16), transparent 60%),
                  linear-gradient(135deg, var(--blue), var(--blue2));
      color:#fff;
      padding:26px 0 64px;
      position:relative;
      overflow:hidden;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:0 18px}
    .toprow{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .brand h1{margin:18px 0 0;font-size:56px;letter-spacing:.02em}
    .brand p{margin:10px 0 0;opacity:.9}
    .actions{display:flex;gap:12px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .pill{
      display:inline-flex;gap:10px;align-items:center;
      padding:10px 14px;border-radius:14px;
      background:rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.22);
      color:#fff;font-weight:900;
      backdrop-filter: blur(6px);
    }
    .btn{
      border:0;border-radius:14px;padding:10px 14px;
      font-weight:900;cursor:pointer;
      transition:transform .06s ease, filter .15s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-ghost{background:rgba(255,255,255,.18);color:#fff;border:1px solid rgba(255,255,255,.22)}
    main{margin-top:-40px;padding:0 0 46px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
    }
    .grid{display:grid;gap:14px;grid-template-columns:repeat(2,1fr)}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} .brand h1{font-size:44px}}
    .menu{
      display:flex;gap:16px;align-items:flex-start;
      padding:18px;border-radius:16px;
      border:1px solid #e6eefc;
      background:#fff;
      text-decoration:none;color:inherit;
      transition:transform .06s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .menu:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(15,23,42,.08);border-color:#cfe0ff}
    .icon{
      width:44px;height:44px;border-radius:14px;
      display:grid;place-items:center;
      background:#eef4ff;border:1px solid #dbe7ff;
      font-size:22px;
      flex:0 0 auto;
    }
    .t{font-weight:1000;font-size:18px;margin-top:2px}
    .d{color:var(--muted);margin-top:4px}
    .subttl{margin:0 0 12px;font-weight:1000}
    .loginline{margin-top:10px;color:rgba(255,255,255,.95);font-weight:800}
    .small{font-size:12px;opacity:.9}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="toprow">
        <div class="brand">
          <div style="opacity:.95;font-weight:900">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
          <h1>3è¡Œã‚¢ãƒ—ãƒªé–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</h1>
          <p>æˆæ¥­å†…å®¹ã‚’ã€Œ3è¡Œã€ã§æŒ¯ã‚Šè¿”ã‚‹å­¦ç¿’æ”¯æ´ã‚¢ãƒ—ãƒª</p>
          <div id="loginLine" class="loginline">ç¢ºèªä¸­â€¦</div>
          <div id="hint" class="small"></div>
        </div>

        <div class="actions">
          <div id="userPill" class="pill" style="display:none;">ğŸ‘¤ <span id="userName"></span></div>
          <button class="btn btn-ghost" onclick="location.href='/account.html'">ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</button>
          <button id="btnLogout" class="btn btn-danger">â» Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="card">
        <h2 class="subttl">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
        <div class="grid">
          <a class="menu" href="/posts.html">
            <div class="icon">ğŸ“</div>
            <div><div class="t">3è¡ŒæŠ•ç¨¿</div><div class="d">æˆæ¥­ã®è¦ç‚¹ã‚’3è¡Œã§æŠ•ç¨¿ã€‚å…ˆç”Ÿã®ã€Œã„ã„ã­ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã€ã‚‚ç¢ºèªã§ãã¾ã™ã€‚</div></div>
          </a>
          <a class="menu" href="/questions.html">
            <div class="icon">ğŸ’¬</div>
            <div><div class="t">è³ªå•æ²ç¤ºæ¿</div><div class="d">æˆæ¥­ä¸­ãƒ»å¾Œã®ç–‘å•ã‚’æŠ•ç¨¿ã€‚å­¦ç”Ÿ/æ•™å“¡ãŒå›ç­”ã—ã¦å­¦ã³åˆã„ã€‚</div></div>
          </a>
          <a class="menu" href="/quizzes.html">
            <div class="icon">ğŸ§ </div>
            <div><div class="t">ã‚¯ã‚¤ã‚º</div><div class="d">æŠ•ç¨¿å†…å®¹ã‹ã‚‰ã€Œæ€ã„å‡ºã—ã‚¯ã‚¤ã‚ºã€ã‚’è¡¨ç¤ºã€‚å¾©ç¿’ã«ä½¿ãˆã¾ã™ã€‚</div></div>
          </a>
          <a class="menu" href="/reminders.html">
            <div class="icon">â°</div>
            <div><div class="t">å¾©ç¿’ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</div><div class="d">æˆæ¥­å¾Œã®å¾©ç¿’ã‚’ç¿’æ…£åŒ–ã€‚æœŸé™ãŒæ¥ãŸå†…å®¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚</div></div>
          </a>
          <a class="menu" href="/ranking.html">
            <div class="icon">ğŸ†</div>
            <div><div class="t">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div><div class="d">æŠ•ç¨¿ãƒ»å›ç­”ãªã©ã®è²¢çŒ®åº¦ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</div></div>
          </a>
          <a class="menu" href="/settings.html">
            <div class="icon">âš™ï¸</div>
            <div><div class="t">è¨­å®š</div><div class="d">è¡¨ç¤ºã‚„å‹•ä½œã®è¨­å®šï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°éè¡¨ç¤ºãªã©ï¼‰</div></div>
          </a>
        </div>
      </div>
    </div>
  </main>

  <script>
    // âœ… æ›´ç¨³çš„ APIï¼šGET ä¸å¼ºè¡ŒåŠ  Content-Typeï¼›åªåœ¨éœ€è¦æ—¶åŠ 
    async function api(path, opt = {}) {
      const method = (opt.method || "GET").toUpperCase();
      const headers = new Headers(opt.headers || {});
      if (method !== "GET" && method !== "HEAD") {
        if (!headers.has("Content-Type")) headers.set("Content-Type", "application/json");
      }

      const res = await fetch(path, {
        credentials: "include",
        ...opt,
        method,
        headers
      });

      const text = await res.text();
      let data;
      try { data = text ? JSON.parse(text) : null; } catch { data = text; }
      if (!res.ok) throw new Error((data && data.error) ? data.error : ("HTTP " + res.status + " " + text));
      return data;
    }

    function gotoLogin(reason) {
      const r = reason ? encodeURIComponent(reason) : "";
      location.replace("/login.html?from=index&reason=" + r + "&ts=" + Date.now());
    }

    async function ensureLogin() {
      const me = await api("/api/auth/me?ts=" + Date.now(), { method: "GET" });
      if (!me || !me.user) {
        gotoLogin("not_logged_in");
        return null;
      }
      return me.user;
    }

    document.getElementById("btnLogout").addEventListener("click", async () => {
      const hint = document.getElementById("hint");
      hint.textContent = "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­â€¦";
      try {
        await api("/api/auth/logout", { method: "POST", body: "{}" });
      } catch (_) {
        // å¤±æ•—ã—ã¦ã‚‚æ¬¡ã¸ï¼ˆcookie ãŒæ¶ˆãˆã¦ã„ã‚Œã°OKï¼‰
      }
      location.replace("/login.html?logged_out=1&ts=" + Date.now());
    });

    (async () => {
      const hint = document.getElementById("hint");
      try {
        const user = await ensureLogin();
        if (!user) return;

        const display = user.display_name || user.username || "User";
        document.getElementById("userPill").style.display = "inline-flex";
        document.getElementById("userName").textContent = display;

        const role = user.role ? ` (${user.role})` : "";
        document.getElementById("loginLine").textContent = `ãƒ­ã‚°ã‚¤ãƒ³: ${display}${role}`;
        hint.textContent = "";
      } catch (e) {
        // âœ… è¿™é‡Œå¦‚æœå¤±è´¥ï¼Œå°±æ˜ç¡®å‘Šè¯‰ä½ ï¼Œç„¶åé€å› login
        document.getElementById("loginLine").textContent = "ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªã‚¨ãƒ©ãƒ¼";
        document.getElementById("hint").textContent = String(e?.message || e);
        gotoLogin("me_fetch_failed");
      }
    })();
  </script>
</body>
</html>
