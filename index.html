<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3è¡Œã‚¢ãƒ—ãƒªé–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</title>
  <style>
    :root{
      --blue:#0b57d0;
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow:0 12px 28px rgba(16,24,40,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;color:var(--text);background:var(--bg)}
    header{
      background:var(--blue);
      color:#fff;
      padding:48px 18px;
      text-align:center;
    }
    header h1{margin:0;font-size:40px;letter-spacing:.02em}
    header p{margin:14px 0 0;color:rgba(255,255,255,.9);font-size:16px}
    .wrap{max-width:1180px;margin:0 auto;padding:28px 18px 56px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:22px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
      border:1px solid rgba(229,231,235,.75);
    }
    .card h2{margin:0 0 14px;font-size:26px}
    .muted{color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:700px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      outline:none;
      font-size:14px;
      background:#fff;
    }
    textarea{min-height:90px;resize:vertical}
    input:focus, select:focus, textarea:focus{border-color:rgba(11,87,208,.55);box-shadow:0 0 0 4px rgba(11,87,208,.12)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.45}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{
      border:0;
      border-radius:12px;
      padding:12px 14px;
      font-weight:700;
      cursor:pointer;
      font-size:14px;
    }
    .primary{background:var(--blue);color:#fff}
    .ghost{background:#f3f4f6;color:#111}
    .danger{background:#fee2e2;color:#991b1b}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;font-size:12px;
      border:1px solid var(--line);background:#fff;color:#111;
    }
    .badge.ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.08);color:#166534}
    .badge.err{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08);color:#7f1d1d}
    .topline{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:#fff;font-size:12px;cursor:pointer;color:#111;
    }
    .tab.active{background:#111;color:#fff;border-color:#111}
    .list{margin-top:12px;display:flex;flex-direction:column;gap:12px}
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      background:#fff;
    }
    .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:12px;margin-bottom:8px}
    .meta b{color:#111}
    ol{margin:8px 0 0 20px;padding:0}
    footer{padding:22px 12px;text-align:center;color:var(--muted)}
    .small{font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    .inline{display:inline-flex;gap:8px;align-items:center;flex-wrap:wrap}
  </style>
</head>

<body>
  <header>
    <h1>3è¡Œã‚¢ãƒ—ãƒªé–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</h1>
    <p>æˆæ¥­å†…å®¹ã‚’ã€Œ3è¡Œã€ã§æŒ¯ã‚Šè¿”ã‚‹å­¦ç¿’æ”¯æ´ã‚¢ãƒ—ãƒª</p>
  </header>

  <div class="wrap">
    <div class="grid">

      <!-- LEFT: Form -->
      <div class="card">
        <h2>3è¡Œã¾ã¨ã‚æŠ•ç¨¿</h2>

        <div class="row">
          <div>
            <label>åå‰ï¼ˆä»®ï¼‰</label>
            <select id="name">
              <option value="æ¥Šæ—»">æ¥Šæ—»</option>
              <option value="é–€ç”°">é–€ç”°</option>
              <option value="é•·å²¡">é•·å²¡</option>
              <option value="ç¥å°¾">ç¥å°¾</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
            <div class="hint">â€» å¾Œã§ã€Œå…¨å“¡åç°¿ã‹ã‚‰é¸æŠã€ã«å¤‰æ›´å¯èƒ½</div>
          </div>

          <div>
            <label>æˆæ¥­æ—¥</label>
            <input id="lessonDate" type="date" />
            <div class="hint">â€» ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä»Šæ—¥ã®æ—¥ä»˜</div>
          </div>
        </div>

        <label>æˆæ¥­å / ãƒ†ãƒ¼ãƒ</label>
        <input id="topic" placeholder="ä¾‹ï¼‰SQLï¼šå¤–éƒ¨çµåˆ / Javaï¼šç¶™æ‰¿" />
        <div class="hint">â€» å¾Œã§ã€Œæˆæ¥­ã”ã¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®šã€ã«ç™ºå±•ã•ã›ã¾ã™</div>

        <label>1è¡Œç›®</label>
        <textarea id="line1" maxlength="80" placeholder="ä»Šæ—¥ã®ãƒã‚¤ãƒ³ãƒˆâ‘ ï¼ˆ80æ–‡å­—ã¾ã§ï¼‰"></textarea>

        <label>2è¡Œç›®</label>
        <textarea id="line2" maxlength="80" placeholder="ä»Šæ—¥ã®ãƒã‚¤ãƒ³ãƒˆâ‘¡ï¼ˆ80æ–‡å­—ã¾ã§ï¼‰"></textarea>

        <label>3è¡Œç›®</label>
        <textarea id="line3" maxlength="80" placeholder="ä»Šæ—¥ã®ãƒã‚¤ãƒ³ãƒˆâ‘¢ï¼ˆ80æ–‡å­—ã¾ã§ï¼‰"></textarea>

        <div class="btns">
          <button class="primary" id="btnSubmit">æŠ•ç¨¿ï¼ˆlocal + D1ï¼‰</button>
          <button class="ghost" id="btnFillSample">ã‚µãƒ³ãƒ—ãƒ«å…¥åŠ›</button>
          <button class="danger" id="btnClearLocal">localStorage å…¨æ¶ˆå»</button>
        </div>

        <div style="margin-top:14px" class="small muted">
          API: <span class="mono" id="apiBaseText"></span>
        </div>
      </div>

      <!-- RIGHT: Feed -->
      <div class="card">
        <div class="topline">
          <h2 style="margin:0">ã¿ã‚“ãªã®æŠ•ç¨¿ï¼ˆä»®ï¼‰</h2>
          <div class="inline">
            <span class="badge" id="localBadge">localStorage: 0ä»¶</span>
            <span class="badge" id="workerBadge">Workers: ?</span>
          </div>
        </div>

        <div style="margin-top:10px" class="tabs">
          <button class="tab active" id="tabLocal">Local</button>
          <button class="tab" id="tabServer">D1ï¼ˆServerï¼‰</button>
          <button class="tab" id="btnRefresh">æ›´æ–°</button>
        </div>

        <div class="hint" style="margin-top:10px">
          â€» ã€Œã„ã„ã­ / ã‚³ãƒ¡ãƒ³ãƒˆ / åˆ†æã€ã¯å¾Œã§è¿½åŠ äºˆå®š
        </div>

        <div class="list" id="list"></div>

        <div class="small muted" style="margin-top:12px">
          â€» D1 é€£æºç¢ºèªã®ã‚³ãƒ„ï¼š<span class="mono">D1ï¼ˆServerï¼‰</span>ã‚¿ãƒ–ã§æŠ•ç¨¿ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸã€‚
        </div>
      </div>

    </div>
  </div>

  <footer>Â© 2025 3è¡Œã‚¢ãƒ—ãƒªé–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</footer>

<script>
  // ====== CONFIG ======
  const API_BASE = "https://three-lines-api.yangjinxu345.workers.dev";
  const LS_KEY = "three_lines_posts_v1";
  const DEFAULT_LIMIT = 30;

  // ====== DOM ======
  const $ = (id) => document.getElementById(id);
  const apiBaseText = $("apiBaseText");
  const workerBadge = $("workerBadge");
  const localBadge = $("localBadge");
  const list = $("list");

  const tabLocal = $("tabLocal");
  const tabServer = $("tabServer");

  let currentTab = "local"; // 'local' | 'server'
  apiBaseText.textContent = API_BASE;

  // ====== Utils ======
  function nowISO() {
    return new Date().toISOString();
  }
  function escapeHtml(s) {
    return (s ?? "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }
  function setBadge(el, text, kind) {
    el.textContent = text;
    el.classList.remove("ok", "err");
    if (kind === "ok") el.classList.add("ok");
    if (kind === "err") el.classList.add("err");
  }

  // ====== LocalStorage ======
  function loadLocalPosts() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch {
      return [];
    }
  }
  function saveLocalPosts(arr) {
    localStorage.setItem(LS_KEY, JSON.stringify(arr));
  }
  function addLocalPost(p) {
    const arr = loadLocalPosts();
    arr.unshift(p);
    saveLocalPosts(arr);
  }

  // ====== Render ======
  function renderPosts(posts, sourceLabel) {
    list.innerHTML = "";
    if (!posts || posts.length === 0) {
      const div = document.createElement("div");
      div.className = "item muted";
      div.textContent = sourceLabel === "server"
        ? "ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆD1ï¼‰ã€‚å·¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æŠ•ç¨¿ã—ã¦ã¿ã¦ãã ã•ã„ã€‚"
        : "ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆlocalStorageï¼‰ã€‚å·¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æŠ•ç¨¿ã—ã¦ã¿ã¦ãã ã•ã„ã€‚";
      list.appendChild(div);
      return;
    }

    for (const p of posts) {
      const div = document.createElement("div");
      div.className = "item";

      const meta = document.createElement("div");
      meta.className = "meta";

      const name = document.createElement("span");
      name.innerHTML = "ğŸ‘¤ <b>" + escapeHtml(p.name || "undefined") + "</b>";

      const topic = document.createElement("span");
      topic.innerHTML = "ğŸŸ¦ " + escapeHtml(p.topic || "(ãƒ†ãƒ¼ãƒãªã—)");

      const date = document.createElement("span");
      date.innerHTML = "ğŸ—“ï¸ " + escapeHtml(p.lesson_date || p.lessonDate || "");

      const created = document.createElement("span");
      const createdVal = p.created_at || p.createdAt || "";
      created.innerHTML = "ğŸ•’ " + escapeHtml(createdVal);

      meta.appendChild(name);
      meta.appendChild(document.createTextNode(" "));
      meta.appendChild(topic);
      meta.appendChild(document.createTextNode(" "));
      meta.appendChild(date);
      if (createdVal) {
        meta.appendChild(document.createTextNode(" "));
        meta.appendChild(created);
      }

      const lines = document.createElement("ol");
      const l1 = document.createElement("li"); l1.textContent = p.line1 || "";
      const l2 = document.createElement("li"); l2.textContent = p.line2 || "";
      const l3 = document.createElement("li"); l3.textContent = p.line3 || "";
      lines.appendChild(l1); lines.appendChild(l2); lines.appendChild(l3);

      div.appendChild(meta);
      div.appendChild(lines);
      list.appendChild(div);
    }
  }

  function refreshLocalUI() {
    const local = loadLocalPosts();
    setBadge(localBadge, `localStorage: ${local.length}ä»¶`, "ok");
    if (currentTab === "local") renderPosts(local, "local");
  }

  // ====== API Calls ======
  async function checkHealth() {
    try {
      const r = await fetch(API_BASE + "/api/health", { method: "GET" });
      if (!r.ok) throw new Error("HTTP " + r.status);
      const j = await r.json();
      if (j.status === "ok") {
        setBadge(workerBadge, "Workers: OK", "ok");
        return true;
      }
      throw new Error("Bad JSON");
    } catch (e) {
      setBadge(workerBadge, "Workers: ERROR", "err");
      return false;
    }
  }

  async function fetchServerPosts() {
    const url = API_BASE + "/api/posts?limit=" + DEFAULT_LIMIT;
    const r = await fetch(url, { method: "GET" });
    if (!r.ok) throw new Error("HTTP " + r.status);
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || "server error");
    return j.data || [];
  }

  async function postToServer(payload) {
    const url = API_BASE + "/api/posts";
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    if (!r.ok) throw new Error("HTTP " + r.status);
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || "server error");
    return j;
  }

  async function refreshServerUI() {
    try {
      const ok = await checkHealth();
      if (!ok) throw new Error("workers not ok");
      const posts = await fetchServerPosts();
      // server tab doesn't show localBadge count (still useful), keep it
      if (currentTab === "server") renderPosts(posts, "server");
    } catch (e) {
      if (currentTab === "server") {
        list.innerHTML = "";
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `<div class="muted">D1 å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>
          <div class="small muted mono" style="margin-top:6px">${escapeHtml(String(e))}</div>
          <div class="small muted" style="margin-top:10px">ã¾ãš <span class="mono">/api/health</span> ãŒ OK ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>`;
        list.appendChild(div);
      }
      setBadge(workerBadge, "Workers: ERROR", "err");
    }
  }

  // ====== Submit ======
  function getFormPayload() {
    const name = $("name").value.trim();
    const lesson_date = $("lessonDate").value; // YYYY-MM-DD
    const topic = $("topic").value.trim();
    const line1 = $("line1").value.trim();
    const line2 = $("line2").value.trim();
    const line3 = $("line3").value.trim();

    return { name, lesson_date, topic, line1, line2, line3 };
  }

  function validate(p) {
    if (!p.name) return "åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
    if (!p.lesson_date) return "æˆæ¥­æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
    if (!p.line1 || !p.line2 || !p.line3) return "1ã€œ3è¡Œç›®ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
    if (p.line1.length > 80 || p.line2.length > 80 || p.line3.length > 80) return "å„è¡Œã¯80æ–‡å­—ä»¥å†…ã§ã™ã€‚";
    return null;
  }

  async function handleSubmit() {
    const p = getFormPayload();
    const err = validate(p);
    if (err) { alert(err); return; }

    // 1) always save local
    const localPost = {
      name: p.name,
      lesson_date: p.lesson_date,
      topic: p.topic,
      line1: p.line1,
      line2: p.line2,
      line3: p.line3,
      createdAt: new Date().toLocaleString()
    };
    addLocalPost(localPost);
    refreshLocalUI();

    // 2) try post to server
    try {
      const ok = await checkHealth();
      if (!ok) throw new Error("Workers not reachable");
      await postToServer(p);
      setBadge(workerBadge, "Workers: OK", "ok");

      // if user is on server tab, refresh it; otherwise keep local view
      await refreshServerUI();
      alert("æŠ•ç¨¿ã—ã¾ã—ãŸï¼(local + D1)");
    } catch (e) {
      setBadge(workerBadge, "Workers: ERROR", "err");
      alert("local ã«ã¯ä¿å­˜ã§ãã¾ã—ãŸãŒã€D1 ã¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n" + e);
    }
  }

  // ====== Events ======
  $("btnSubmit").addEventListener("click", handleSubmit);

  $("btnFillSample").addEventListener("click", () => {
    $("topic").value = "ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢å·¥å­¦";
    $("line1").value = "111æœˆ";
    $("line2").value = "222";
    $("line3").value = "333";
  });

  $("btnClearLocal").addEventListener("click", () => {
    if (!confirm("localStorage ã®æŠ•ç¨¿ã‚’å…¨æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    localStorage.removeItem(LS_KEY);
    refreshLocalUI();
    if (currentTab === "local") renderPosts([], "local");
  });

  tabLocal.addEventListener("click", () => {
    currentTab = "local";
    tabLocal.classList.add("active");
    tabServer.classList.remove("active");
    refreshLocalUI();
  });

  tabServer.addEventListener("click", async () => {
    currentTab = "server";
    tabServer.classList.add("active");
    tabLocal.classList.remove("active");
    await refreshServerUI();
  });

  $("btnRefresh").addEventListener("click", async () => {
    if (currentTab === "local") refreshLocalUI();
    else await refreshServerUI();
  });

  // ====== Init ======
  (function init(){
    // set date default = today (local time)
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    $("lessonDate").value = `${yyyy}-${mm}-${dd}`;

    refreshLocalUI();
    checkHealth(); // show initial status
    // default show local
    renderPosts(loadLocalPosts(), "local");
  })();
</script>
</body>
</html>
