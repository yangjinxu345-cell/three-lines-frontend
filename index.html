<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3è¡Œã‚¢ãƒ—ãƒªé–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</title>
  <style>
    :root{
      --blue:#0b5ed7;
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#1b1f2a;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 10px 25px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      color:var(--text);
      background:var(--bg);
    }
    header{
      background:var(--blue);
      color:#fff;
      padding:42px 18px 52px;
      text-align:center;
    }
    header h1{
      margin:0;
      font-weight:800;
      letter-spacing:.02em;
      font-size:40px;
    }
    header p{
      margin:14px 0 0;
      opacity:.95;
      font-size:18px;
    }
    .wrap{
      max-width:1200px;
      margin:-44px auto 60px;
      padding:0 18px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:22px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:26px;
    }
    .card h2{
      margin:0 0 18px;
      font-size:28px;
      font-weight:800;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      align-items:end;
    }
    @media (max-width: 680px){
      .row{grid-template-columns:1fr}
    }
    label{
      display:block;
      font-weight:700;
      margin:10px 0 8px;
    }
    .hint{
      margin:6px 0 0;
      font-size:13px;
      color:var(--muted);
      line-height:1.4;
    }
    input, select, textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px 12px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    textarea{
      min-height:78px;
      resize:vertical;
    }
    input:focus, select:focus, textarea:focus{
      border-color:#9bbcf2;
      box-shadow:0 0 0 4px rgba(11,94,215,.12);
    }
    .btns{
      display:flex;
      gap:10px;
      margin-top:16px;
      align-items:center;
    }
    button{
      border:0;
      border-radius:12px;
      padding:12px 16px;
      font-size:16px;
      cursor:pointer;
      font-weight:800;
    }
    .primary{
      background:var(--blue);
      color:#fff;
    }
    .ghost{
      background:#eef2ff;
      color:#1f2a44;
    }
    .danger{
      background:#ffe7e7;
      color:#9b1c1c;
    }
    .statusbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin:-6px 0 14px;
      color:var(--muted);
      font-size:14px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:#bbb;
      display:inline-block;
    }
    .dot.ok{background:#22c55e}
    .dot.ng{background:#ef4444}
    .list{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:8px;
    }
    .post{
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px 14px;
      background:#fff;
    }
    .post .meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      color:var(--muted);
      font-size:13px;
      margin-bottom:10px;
    }
    .badge{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:5px 10px;
      border-radius:999px;
      background:#f3f4f6;
      border:1px solid var(--border);
      color:#111827;
      font-size:13px;
      font-weight:700;
    }
    .lines{
      margin:0;
      padding-left:18px;
      line-height:1.7;
      font-size:15px;
    }
    footer{
      text-align:center;
      color:var(--muted);
      padding:26px 12px 50px;
      font-size:13px;
    }
    .msg{
      margin-top:10px;
      color:var(--muted);
      font-size:14px;
      line-height:1.45;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
<header>
  <h1>3è¡Œã‚¢ãƒ—ãƒªé–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</h1>
  <p>æˆæ¥­å†…å®¹ã‚’ã€Œ3è¡Œã€ã§æŒ¯ã‚Šè¿”ã‚‹å­¦ç¿’æ”¯æ´ã‚¢ãƒ—ãƒª</p>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: form -->
    <section class="card">
      <h2>3è¡Œã¾ã¨ã‚æŠ•ç¨¿</h2>

      <div class="row">
        <div>
          <label for="name">åå‰ï¼ˆä»®ï¼‰</label>
          <select id="name">
            <option value="æ¥Šæ—»">æ¥Šæ—»</option>
            <option value="é–€ç”°">é–€ç”°</option>
            <option value="é•·å²¡">é•·å²¡</option>
            <option value="ç¥å°¾">ç¥å°¾</option>
          </select>
          <div class="hint">â€» å¾Œã§ã€Œå…¨å“¡åç°¿ã‹ã‚‰é¸æŠã€ã«å¤‰æ›´å¯èƒ½</div>
        </div>

        <div>
          <label for="lesson_date">æˆæ¥­æ—¥</label>
          <input id="lesson_date" type="date" />
          <div class="hint">â€» ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä»Šæ—¥ã®æ—¥ä»˜</div>
        </div>
      </div>

      <label for="topic">æˆæ¥­å / ãƒ†ãƒ¼ãƒ</label>
      <input id="topic" type="text" placeholder="ä¾‹ï¼‰SQLï¼šå¤–éƒ¨çµåˆ / Javaï¼šç¶™æ‰¿" />
      <div class="hint">â€» å¾Œã§ã€Œæˆæ¥­ã”ã¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®šã€ã«ç™ºå±•ã•ã›ã¾ã™</div>

      <label for="line1">1è¡Œç›®</label>
      <textarea id="line1" maxlength="80" placeholder="ä»Šæ—¥ã®ãƒã‚¤ãƒ³ãƒˆâ‘ ï¼ˆ80æ–‡å­—ã¾ã§ï¼‰"></textarea>

      <label for="line2">2è¡Œç›®</label>
      <textarea id="line2" maxlength="80" placeholder="ä»Šæ—¥ã®ãƒã‚¤ãƒ³ãƒˆâ‘¡ï¼ˆ80æ–‡å­—ã¾ã§ï¼‰"></textarea>

      <label for="line3">3è¡Œç›®</label>
      <textarea id="line3" maxlength="80" placeholder="ä»Šæ—¥ã®ãƒã‚¤ãƒ³ãƒˆâ‘¢ï¼ˆ80æ–‡å­—ã¾ã§ï¼‰"></textarea>

      <div class="btns">
        <button class="primary" id="btnSubmit">æŠ•ç¨¿ï¼ˆD1ã¸ï¼‰</button>
        <button class="ghost" id="btnReload" type="button">ä¸€è¦§ã‚’æ›´æ–°</button>
        <button class="danger" id="btnClear" type="button" title="å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
      </div>

      <div class="msg" id="msg"></div>
    </section>

    <!-- RIGHT: list -->
    <section class="card">
      <h2>ã¿ã‚“ãªã®æŠ•ç¨¿ï¼ˆD1ï¼‰</h2>

      <div class="statusbar">
        <span class="pill">
          <span class="dot" id="apiDot"></span>
          <span id="apiText">API: -</span>
        </span>
        <span class="pill">
          ä¿å­˜å…ˆï¼šD1ï¼ˆPages Functionsï¼‰
        </span>
        <span class="pill">
          <span id="countText">0ä»¶</span>
        </span>
      </div>

      <div class="list" id="list"></div>

      <div class="hint" style="margin-top:14px;">
        â€» ã€Œã„ã„ã­ / ã‚³ãƒ¡ãƒ³ãƒˆ / åˆ†æã€ã¯å¾Œã§è¿½åŠ äºˆå®š
      </div>
    </section>
  </div>
</div>

<footer>Â© 2025 3è¡Œã‚¢ãƒ—ãƒªé–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</footer>

<script>
  // ---------- utils ----------
  function escapeHtml(v){
    const s = String(v ?? ""); // â† ã“ã“ã§å¿…ãšæ–‡å­—åˆ—ã«ã™ã‚‹ï¼ˆreplace is not a function å¯¾ç­–ï¼‰
    return s
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function todayYmd(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function setApiStatus(ok, text){
    const dot = document.getElementById("apiDot");
    const t = document.getElementById("apiText");
    dot.classList.remove("ok","ng");
    if(ok === true) dot.classList.add("ok");
    if(ok === false) dot.classList.add("ng");
    t.textContent = text;
  }

  function setMsg(s){
    document.getElementById("msg").textContent = s || "";
  }

  // ---------- DOM ----------
  const $name = document.getElementById("name");
  const $date = document.getElementById("lesson_date");
  const $topic = document.getElementById("topic");
  const $l1 = document.getElementById("line1");
  const $l2 = document.getElementById("line2");
  const $l3 = document.getElementById("line3");
  const $list = document.getElementById("list");
  const $countText = document.getElementById("countText");

  // ---------- API ----------
  async function apiGetPosts(limit = 50){
    const res = await fetch(`/api/posts?limit=${limit}`, { method:"GET" });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = { ok:false, raw:text }; }
    return { res, data };
  }

  async function apiCreatePost(payload){
    const res = await fetch(`/api/posts`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = { ok:false, raw:text }; }
    return { res, data };
  }

  // ---------- render ----------
  function renderPosts(items){
    $list.innerHTML = "";
    $countText.textContent = `${items.length}ä»¶`;

    if(!items.length){
      $list.innerHTML = `<div class="hint">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æŠ•ç¨¿ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</div>`;
      return;
    }

    for(const p of items){
      const name = escapeHtml(p.name);
      const cls  = escapeHtml(p.class_name ?? "");
      const date = escapeHtml(p.lesson_date);
      const topic = escapeHtml(p.topic ?? "");
      const created = escapeHtml(p.created_at ?? "");

      const html = `
        <div class="post">
          <div class="meta">
            <span class="badge">ğŸ‘¤ ${name}</span>
            ${cls ? `<span class="badge">ğŸ« ${cls}</span>` : ""}
            ${topic ? `<span class="badge">ğŸ§© ${topic}</span>` : ""}
            <span class="badge">ğŸ“… ${date}</span>
            ${created ? `<span class="badge">ğŸ•’ ${created}</span>` : ""}
            <span class="badge">#${escapeHtml(p.id)}</span>
          </div>
          <ol class="lines">
            <li>${escapeHtml(p.line1)}</li>
            <li>${escapeHtml(p.line2)}</li>
            <li>${escapeHtml(p.line3)}</li>
          </ol>
        </div>
      `;
      $list.insertAdjacentHTML("beforeend", html);
    }
  }

  async function refreshPosts(){
    setMsg("");
    try{
      const { res, data } = await apiGetPosts(50);
      if(res.ok && data && data.ok){
        setApiStatus(true, "API: OK");
        renderPosts(data.items || []);
      }else{
        setApiStatus(false, `API: NG (${res.status})`);
        setMsg(`ä¸€è¦§å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nHTTP ${res.status}\n${JSON.stringify(data, null, 2)}`);
      }
    }catch(e){
      setApiStatus(false, "API: NG (network)");
      setMsg(`ä¸€è¦§å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆnetworkï¼‰ã€‚\n${e}`);
    }
  }

  async function submitPost(){
    setMsg("");
    const payload = {
      name: $name.value.trim(),
      class_name: "ITE2", // ä»Šã¯å›ºå®šï¼ˆå¿…è¦ãªã‚‰ã‚ã¨ã§UIã«å‡ºã™ï¼‰
      lesson_date: $date.value,
      topic: $topic.value.trim(),
      line1: $l1.value.trim(),
      line2: $l2.value.trim(),
      line3: $l3.value.trim()
    };

    // ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if(!payload.name || !payload.lesson_date || !payload.line1 || !payload.line2 || !payload.line3){
      setMsg("å¿…é ˆé …ç›®ï¼ˆåå‰/æˆæ¥­æ—¥/1ã€œ3è¡Œç›®ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    try{
      const { res, data } = await apiCreatePost(payload);
      if(res.ok && data && data.ok){
        setApiStatus(true, "API: OK");
        setMsg(`âœ… æŠ•ç¨¿ã—ã¾ã—ãŸï¼ˆid=${data.id}ï¼‰`);
        // æŠ•ç¨¿å¾Œã«ä¸€è¦§æ›´æ–°
        await refreshPosts();
      }else{
        setApiStatus(false, `API: NG (${res.status})`);
        setMsg(`æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nHTTP ${res.status}\n${JSON.stringify(data, null, 2)}`);
      }
    }catch(e){
      setApiStatus(false, "API: NG (network)");
      setMsg(`æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆnetworkï¼‰ã€‚\n${e}`);
    }
  }

  function clearInputs(){
    $topic.value = "";
    $l1.value = "";
    $l2.value = "";
    $l3.value = "";
    setMsg("");
  }

  // ---------- init ----------
  (function init(){
    $date.value = todayYmd();

    document.getElementById("btnSubmit").addEventListener("click", (e)=>{
      e.preventDefault();
      submitPost();
    });
    document.getElementById("btnReload").addEventListener("click", (e)=>{
      e.preventDefault();
      refreshPosts();
    });
    document.getElementById("btnClear").addEventListener("click", (e)=>{
      e.preventDefault();
      clearInputs();
    });

    refreshPosts();
  })();
</script>
</body>
</html>
