<script>
  async function apiMe() {
    const r = await fetch("/api/auth/me", {
      cache: "no-store",
      credentials: "include",
    });
    const j = await r.json();
    return j && j.ok ? j.user : null;
  }

  async function ensureLogin() {
    try {
      const user = await apiMe();
      if (!user) {
        // 统一跳 login.html
        location.replace("/login.html?next=/index.html");
        return;
      }
      const el = document.getElementById("loginInfo");
      if (el) el.textContent = `ログイン：${user.display_name}（${user.username}） role=${user.role}`;
    } catch {
      location.replace("/login.html?next=/index.html");
    }
  }

  async function hardLogout() {
    try {
      await fetch("/api/auth/logout", {
        method: "POST",
        cache: "no-store",
        credentials: "include",
      });
    } catch {}

    // 清本地数据（避免串号）
    try { localStorage.clear(); } catch {}
    try { sessionStorage.clear(); } catch {}

    // 清缓存
    try {
      if (window.caches) {
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
      }
    } catch {}

    // 注销 SW
    try {
      if (navigator.serviceWorker) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
      }
    } catch {}

    location.replace("/login.html");
  }

  // 绑定 logout
  const btn = document.getElementById("btnLogout");
  if (btn) btn.addEventListener("click", hardLogout);

  
  ensureLogin();
</script>
