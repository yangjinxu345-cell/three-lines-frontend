<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3è¡Œã‚¢ãƒ—ãƒªé–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#1769ff">

  <style>
    :root{--blue1:#1e6bff;--blue2:#1657ff;--card:#fff;--bg:#f3f6fb;--text:#0f172a;--muted:#64748b;--shadow:0 10px 30px rgba(15,23,42,.12);--radius:18px}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial,sans-serif;background:var(--bg);color:var(--text)}
    .hero{position:relative;background:linear-gradient(135deg,var(--blue1),var(--blue2));color:#fff;padding:42px 24px 56px;overflow:hidden}
    .hero::before,.hero::after{content:"";position:absolute;width:520px;height:520px;border-radius:999px;background:rgba(255,255,255,.10)}
    .hero::before{left:-220px;top:-220px}
    .hero::after{right:-220px;top:-140px}
    .hero-inner{max-width:1100px;margin:0 auto;position:relative}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:22px}
    .actions{display:flex;gap:10px;align-items:center}
    .btn{border:none;cursor:pointer;border-radius:999px;padding:10px 14px;font-weight:700;display:inline-flex;align-items:center;gap:8px;transition:.15s transform,.15s opacity,.15s box-shadow;box-shadow:0 8px 18px rgba(0,0,0,.12);user-select:none}
    .btn:hover{transform:translateY(-1px);opacity:.95}
    .btn:active{transform:translateY(0px);opacity:.9}
    .btn-ghost{background:rgba(255,255,255,.15);color:#fff;box-shadow:none;border:1px solid rgba(255,255,255,.25)}
    .btn-danger{background:#ff4d4f;color:#fff}
    .title{font-size:44px;font-weight:900;margin:0 0 10px;line-height:1.1}
    .subtitle{margin:0;color:rgba(255,255,255,.88);font-size:16px;line-height:1.7;max-width:720px}
    .wrap{max-width:1100px;margin:-40px auto 36px;padding:0 18px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
    @media (max-width:860px){.title{font-size:34px}.grid{grid-template-columns:1fr}}
    .tile{display:flex;gap:14px;padding:16px;border-radius:16px;border:1px solid #e7eefb;text-decoration:none;color:inherit;background:#fff;transition:.15s transform,.15s box-shadow}
    .tile:hover{transform:translateY(-1px);box-shadow:0 10px 26px rgba(15,23,42,.10)}
    .icon{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,#eaf2ff,#fff);display:flex;align-items:center;justify-content:center;border:1px solid #e7eefb;font-size:20px}
    .tile h3{margin:0 0 4px;font-size:16px;font-weight:900}
    .tile p{margin:0;color:var(--muted);font-size:13px;line-height:1.55}
    .userline{margin-top:14px;font-size:12px;color:rgba(255,255,255,.85)}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.16);border:1px solid rgba(255,255,255,.22);margin-left:8px;font-weight:700}
  </style>
</head>
<body>
  <header class="hero">
    <div class="hero-inner">
      <div class="topbar">
        <div style="font-weight:800;opacity:.9">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
        <div class="actions">
          <button id="btnAccount" class="btn btn-ghost" type="button">ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</button>
          <button id="btnLogout" class="btn btn-danger" type="button">â» Logout</button>
        </div>
      </div>

      <h1 class="title">3è¡Œã‚¢ãƒ—ãƒªé–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</h1>
      <p class="subtitle">æˆæ¥­å†…å®¹ã‚’ã€Œ3è¡Œã€ã§æŒ¯ã‚Šè¿”ã‚‹å­¦ç¿’æ”¯æ´ã‚¢ãƒ—ãƒª</p>
      <div class="userline" id="userLine">ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªä¸­...</div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="grid">
        <a class="tile" href="/posts.html"><div class="icon">ğŸ“</div><div><h3>3è¡ŒæŠ•ç¨¿</h3><p>æˆæ¥­ã®è¦ç‚¹ã‚’æŠ•ç¨¿ã€‚å…ˆç”Ÿã®ã„ã„ã­ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã‚‚ã€‚</p></div></a>
        <a class="tile" href="/questions.html"><div class="icon">ğŸ’¬</div><div><h3>è³ªå•æ²ç¤ºæ¿</h3><p>ç–‘å•ã‚’æŠ•ç¨¿ã—ã€å­¦ã³åˆã†ã€‚</p></div></a>
        <a class="tile" href="/quizzes.html"><div class="icon">ğŸ§ </div><div><h3>ã‚¯ã‚¤ã‚º</h3><p>æ€ã„å‡ºã—ã‚¯ã‚¤ã‚ºã§å¾©ç¿’ã€‚</p></div></a>
        <a class="tile" href="/reminders.html"><div class="icon">â°</div><div><h3>å¾©ç¿’ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</h3><p>æœŸé™ãŒæ¥ãŸå¾©ç¿’ã‚’ç¢ºèªã€‚</p></div></a>
        <a class="tile" href="/ranking.html"><div class="icon">ğŸ†</div><div><h3>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3><p>è²¢çŒ®åº¦ã‚’è¡¨ç¤ºã€‚</p></div></a>
        <a class="tile" href="/settings.html"><div class="icon">âš™ï¸</div><div><h3>è¨­å®š</h3><p>è¡¨ç¤ºãƒ»å‹•ä½œã®è¨­å®šã€‚</p></div></a>
      </div>
    </section>
  </main>

  <script>
    async function fetchMe() {
      const r = await fetch("/api/auth/me?ts=" + Date.now(), {
        method: "GET",
        credentials: "include",
        cache: "no-store",
        headers: { "Accept": "application/json" },
      });
      return await r.json().catch(() => null);
    }

    function gotoLogin() {
      const next = encodeURIComponent(location.pathname || "/index.html");
      location.replace("/login.html?next=" + next);
    }

    async function doLogoutHard() {
      // å…ˆ POSTï¼ˆå¦‚æœåç«¯æ”¯æŒï¼‰ï¼Œå¤±è´¥å°± fallback GETï¼ˆä½ ä¹‹å‰æˆªå›¾è¯æ˜ GET å¯ç”¨ï¼‰
      try {
        const r = await fetch("/api/auth/logout?ts=" + Date.now(), {
          method: "POST",
          credentials: "include",
          cache: "no-store",
          headers: { "Content-Type": "application/json", "Accept": "application/json" },
          body: "{}",
        });
        if (!r.ok) throw new Error("POST logout failed");
      } catch (e) {
        try {
          await fetch("/api/auth/logout?ts=" + Date.now(), {
            method: "GET",
            credentials: "include",
            cache: "no-store",
            headers: { "Accept": "application/json" },
          });
        } catch {}
      }

      // æ¸…ç†å‰ç«¯ç¼“å­˜ï¼ˆä¸å¼ºåˆ¶ï¼Œä½†èƒ½å‡å°‘ä½ é‡åˆ°çš„â€œæ¢è´¦å·ä¸ç”Ÿæ•ˆâ€ï¼‰
      try {
        localStorage.clear();
        sessionStorage.clear();
        if (window.caches && caches.keys) {
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
      } catch {}
    }

    async function initAuthGate() {
      const me = await fetchMe();
      if (!me || !me.ok || !me.user) {
        gotoLogin();
        return;
      }

      const u = me.user;
      const userLine = document.getElementById("userLine");
      userLine.textContent = `ãƒ­ã‚°ã‚¤ãƒ³: ${u.display_name} (${u.username})`;
      const roleBadge = document.createElement("span");
      roleBadge.className = "badge";
      roleBadge.textContent = "role=" + u.role;
      userLine.appendChild(roleBadge);

      document.getElementById("btnAccount").onclick = () => location.href = "/account.html";

      document.getElementById("btnLogout").onclick = async () => {
        await doLogoutHard();
        // ç™»å‡ºåï¼Œæ˜ç¡®å›ç™»å½•é¡µï¼ˆè€Œä¸æ˜¯ /ï¼Œé¿å…è¢« _redirects å½±å“ä½ è°ƒè¯•ï¼‰
        location.replace("/login.html");
      };
    }

    initAuthGate();
  </script>
</body>
</html>
