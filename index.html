<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3è¡Œã‚¢ãƒ—ãƒªé–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#fff;
      --text:#1f2937;
      --muted:#6b7280;
      --primary:#0b5bd3;
      --border:#e5e7eb;
      --shadow: 0 10px 30px rgba(15,23,42,.10);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }
    header{
      background: linear-gradient(0deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02)), var(--primary);
      color:#fff;
      padding:44px 18px 70px;
      text-align:center;
    }
    header h1{margin:0; font-size:40px; letter-spacing:1px}
    header p{margin:10px 0 0; opacity:.9}
    .wrap{max-width:1180px; margin:-55px auto 40px; padding:0 16px;}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1.2fr;
      gap:18px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    .card h2{margin:6px 0 14px; font-size:26px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      outline:none;
      font-size:14px;
      background:#fff;
    }
    textarea{min-height:84px; resize:vertical}
    .hint{font-size:12px; color:var(--muted); margin-top:6px}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      border:0;
      background:var(--primary);
      color:#fff;
      padding:11px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
    }
    button.secondary{
      background:#eef2ff;
      color:#1d4ed8;
      border:1px solid #dbeafe;
    }
    button.ghost{
      background:#fff;
      color:var(--text);
      border:1px solid var(--border);
    }
    button:disabled{opacity:.6; cursor:not-allowed}
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .tab{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      cursor:pointer;
      font-weight:600;
      font-size:13px;
    }
    .tab.active{
      border-color:#bcd7ff;
      background:#eef6ff;
      color:#0b5bd3;
    }
    .toolbar{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:space-between;
      flex-wrap:wrap;
      margin:10px 0 12px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:13px;
      color:var(--muted);
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:#22c55e}
    .dot.bad{background:#ef4444}
    .list{display:flex; flex-direction:column; gap:12px}
    .item{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .meta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:8px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:#f3f4f6;
      border:1px solid #eef2f7;
      font-size:13px;
    }
    .tag strong{font-weight:700; color:#111827}
    .small{font-size:12px; color:var(--muted)}
    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .answerBox{
      border-top:1px dashed var(--border);
      margin-top:10px;
      padding-top:10px;
    }
    .answerRow{display:flex; gap:8px; flex-wrap:wrap}
    .answerRow input{flex:1; min-width:180px}
    .answerRow button{white-space:nowrap}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .rightTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .countBadge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:34px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      font-weight:700;
    }
    .mutedLine{color:var(--muted); font-size:13px; margin-top:4px}
    @media (max-width: 980px){
      header h1{font-size:30px}
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<header>
  <h1>3è¡Œã‚¢ãƒ—ãƒªé–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</h1>
  <p>æˆæ¥­å†…å®¹ã‚’ã€Œ3è¡Œã€ã§æŒ¯ã‚Šè¿”ã‚‹å­¦ç¿’æ”¯æ´ã‚¢ãƒ—ãƒª</p>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT -->
    <section class="card">
      <h2>3è¡Œã¾ã¨ã‚æŠ•ç¨¿</h2>

      <div class="row">
        <div>
          <label>åå‰ï¼ˆä»®ï¼‰</label>
          <select id="name">
            <option value="æ¥Šæ—»">æ¥Šæ—»</option>
            <option value="æµ‹è¯•">æµ‹è¯•</option>
            <option value="å­¦ç”ŸA">å­¦ç”ŸA</option>
            <option value="å­¦ç”ŸB">å­¦ç”ŸB</option>
          </select>
          <div class="hint">â€» å¾Œã§ã€Œå…¨å“¡åç°¿ã‹ã‚‰é¸æŠã€ã«å¤‰æ›´å¯èƒ½</div>
        </div>
        <div>
          <label>æˆæ¥­æ—¥</label>
          <input id="lesson_date" type="date" />
          <div class="hint">â€» ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä»Šæ—¥ã®æ—¥ä»˜</div>
        </div>
      </div>

      <label>æˆæ¥­å / ãƒ†ãƒ¼ãƒ</label>
      <input id="topic" placeholder="ä¾‹ï¼‰SQLï¼šå¤–éƒ¨çµåˆ / Javaï¼šç¶™æ‰¿" />

      <label>ã‚¯ãƒ©ã‚¹ï¼ˆä»»æ„ï¼‰</label>
      <input id="class_name" placeholder="ä¾‹ï¼‰ITE2 / ITE3" />

      <label>1è¡Œç›®</label>
      <textarea id="line1" placeholder="ä»Šæ—¥ã®ãƒã‚¤ãƒ³ãƒˆâ‘ ï¼ˆ80æ–‡å­—ã¾ã§ï¼‰"></textarea>

      <label>2è¡Œç›®</label>
      <textarea id="line2" placeholder="ä»Šæ—¥ã®ãƒã‚¤ãƒ³ãƒˆâ‘¡ï¼ˆ80æ–‡å­—ã¾ã§ï¼‰"></textarea>

      <label>3è¡Œç›®</label>
      <textarea id="line3" placeholder="ä»Šæ—¥ã®ãƒã‚¤ãƒ³ãƒˆâ‘¢ï¼ˆ80æ–‡å­—ã¾ã§ï¼‰"></textarea>

      <div class="btns">
        <button id="btnPost">D1ã«æŠ•ç¨¿ï¼ˆ/api/postsï¼‰</button>
        <button class="secondary" id="btnLoadPosts">ä¸€è¦§ã‚’æ›´æ–°</button>
        <button class="ghost" id="btnClear">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
      </div>

      <hr style="border:0;border-top:1px solid var(--border); margin:18px 0;">

      <h2>è³ªå•ãƒ»ç–‘å•æ²ç¤ºæ¿</h2>

      <label>è³ªå•ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input id="q_title" placeholder="ä¾‹ï¼‰LEFT JOIN ã¨ WHERE ã®é•ã„ãŒåˆ†ã‹ã‚‰ãªã„" />

      <label>è³ªå•å†…å®¹</label>
      <textarea id="q_body" placeholder="ä¾‹ï¼‰WHEREã«æ¡ä»¶ã‚’æ›¸ãã¨å¤–éƒ¨çµåˆã®çµæœãŒå¤‰ã‚ã‚‹ç†ç”±ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚"></textarea>

      <div class="btns">
        <button id="btnAsk">è³ªå•ã‚’æŠ•ç¨¿ï¼ˆ/api/questionsï¼‰</button>
        <button class="secondary" id="btnLoadQuestions">è³ªå•ä¸€è¦§ã‚’æ›´æ–°</button>
      </div>

      <div class="hint">â€» ã€Œå›ç­”ã€ã€Œè§£æ±ºæ¸ˆã¿ã€ã¯å³å´ã®ã€Œè³ªå•æ²ç¤ºæ¿ã€ã‚¿ãƒ–ã‹ã‚‰æ“ä½œã§ãã¾ã™ã€‚</div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <div class="rightTitle">
        <div>
          <h2 style="margin:6px 0 2px;">ã¿ã‚“ãªã®æ©Ÿèƒ½ï¼ˆD1 / Functionsï¼‰</h2>
          <div class="mutedLine">ä¿å­˜å…ˆï¼šD1ï¼ˆPages Functionsï¼‰</div>
        </div>
        <div class="countBadge" id="badgeCount">â€”</div>
      </div>

      <div class="toolbar">
        <div class="pill" id="apiStatus">
          <span class="dot bad" id="apiDot"></span>
          <span>API: æœªç¢ºèª</span>
        </div>
        <div class="pill">
          <span class="mono">Base</span>
          <span class="mono">/api/*</span>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="posts">3è¡ŒæŠ•ç¨¿</button>
        <button class="tab" data-tab="questions">è³ªå•æ²ç¤ºæ¿</button>
        <button class="tab" data-tab="quizzes">ã‚¯ã‚¤ã‚º</button>
        <button class="tab" data-tab="reminders">å¾©ç¿’ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</button>
        <button class="tab" data-tab="ranking">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
        <button class="tab" data-tab="settings">è¨­å®š</button>
      </div>

      <div id="panel-posts" class="panel">
        <div class="toolbar">
          <div class="pill"><span class="dot ok"></span> <span>æŠ•ç¨¿ä¸€è¦§ï¼ˆæœ€æ–°é †ï¼‰</span></div>
          <div class="btns" style="margin:0;">
            <button class="secondary" onclick="loadPosts()">æ›´æ–°</button>
          </div>
        </div>
        <div class="list" id="postsList"></div>
      </div>

      <div id="panel-questions" class="panel" style="display:none;">
        <div class="toolbar">
          <div class="pill"><span class="dot ok"></span> <span>è³ªå•ä¸€è¦§ï¼ˆå›ç­”ãƒ»è§£æ±ºï¼‰</span></div>
          <div class="btns" style="margin:0;">
            <button class="secondary" onclick="loadQuestions()">æ›´æ–°</button>
          </div>
        </div>
        <div class="list" id="questionsList"></div>
      </div>

      <div id="panel-quizzes" class="panel" style="display:none;">
        <div class="toolbar">
          <div class="pill"><span class="dot ok"></span> <span>æ€ã„å‡ºã—ã‚¯ã‚¤ã‚ºï¼ˆAPIï¼‰</span></div>
          <div class="btns" style="margin:0;">
            <button class="secondary" onclick="loadQuizzes()">æ›´æ–°</button>
          </div>
        </div>
        <div class="list" id="quizzesList"></div>
        <div class="hint">â€» é€šçŸ¥ï¼ˆpushï¼‰ã¯é›£ã—ã„ã®ã§ã€ä»Šã¯ã€Œã‚¯ã‚¤ã‚ºä¸€è¦§ã‚’é–‹ãï¼é€šçŸ¥ã®ä»£æ›¿ã€ã«ã—ã¦ã„ã¾ã™ã€‚</div>
      </div>

      <div id="panel-reminders" class="panel" style="display:none;">
        <div class="toolbar">
          <div class="pill"><span class="dot ok"></span> <span>å¾©ç¿’ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</span></div>
          <div class="btns" style="margin:0;">
            <button class="secondary" onclick="loadRemindersQuick('today')">ä»Šæ—¥</button>
            <button class="secondary" onclick="loadRemindersQuick('tomorrow')">æ˜æ—¥</button>
            <button class="secondary" onclick="loadRemindersQuick('week')">7æ—¥å¾Œ</button>
          </div>
        </div>
        <div class="list" id="remindersList"></div>
      </div>

      <div id="panel-ranking" class="panel" style="display:none;">
        <div class="toolbar">
          <div class="pill"><span class="dot ok"></span> <span>è²¢çŒ®åº¦ï¼ˆæŠ•ç¨¿æ•°ãƒ»å›ç­”æ•°ï¼‰</span></div>
          <div class="btns" style="margin:0;">
            <button class="secondary" onclick="loadRanking()">æ›´æ–°</button>
          </div>
        </div>
        <div class="list" id="rankingList"></div>
        <div class="hint">â€» å°†æ¥ã€Œéè¡¨ç¤ºè¨­å®šã€ã‚‚å¯èƒ½ï¼ˆè¨­å®šã‚¿ãƒ–ã§ãƒ•ãƒ©ã‚°ç®¡ç†ã§ãã¾ã™ï¼‰ã€‚</div>
      </div>

      <div id="panel-settings" class="panel" style="display:none;">
        <div class="toolbar">
          <div class="pill"><span class="dot ok"></span> <span>è¨­å®šï¼ˆ/api/settingsï¼‰</span></div>
          <div class="btns" style="margin:0;">
            <button class="secondary" onclick="loadSettings()">èª­ã¿è¾¼ã¿</button>
          </div>
        </div>

        <div class="row">
          <div>
            <label>ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º</label>
            <select id="set_showRanking">
              <option value="1">è¡¨ç¤ºã™ã‚‹</option>
              <option value="0">éè¡¨ç¤º</option>
            </select>
          </div>
          <div>
            <label>æ—¢å®šã‚¯ãƒ©ã‚¹åï¼ˆä»»æ„ï¼‰</label>
            <input id="set_defaultClass" placeholder="ä¾‹ï¼‰ITE2" />
          </div>
        </div>

        <div class="btns">
          <button onclick="saveSettings()">ä¿å­˜</button>
        </div>

        <div class="hint">â€» ã“ã“ã¯æœ€å°å®Ÿè£…ã€‚å¿…è¦ãªã‚‰é …ç›®ã‚’è¿½åŠ ã—ã¦ã„ã‘ã¾ã™ã€‚</div>
      </div>

    </section>
  </div>
</div>

<script>
  // -----------------------
  // helpers
  // -----------------------
  function pad2(n){ return String(n).padStart(2,'0'); }
  function toISODate(d){
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function escapeHtml(s){
    const str = String(s ?? "");
    return str.replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }
  function $(id){ return document.getElementById(id); }

  async function apiFetch(path, opts = {}){
    const res = await fetch(path, {
      headers: { "Content-Type": "application/json", ...(opts.headers||{}) },
      ...opts
    });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = { raw:text }; }
    if(!res.ok){
      const msg = (data && (data.error || data.message)) ? (data.error || data.message) : text;
      throw new Error(`HTTP ${res.status}: ${msg}`);
    }
    return data;
  }

  function setApiStatus(ok, msg){
    const dot = $("apiDot");
    const box = $("apiStatus");
    dot.className = "dot " + (ok ? "ok" : "bad");
    box.innerHTML = `<span class="dot ${ok ? "ok" : "bad"}"></span><span>API: ${escapeHtml(msg)}</span>`;
  }

  // -----------------------
  // tabs
  // -----------------------
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      document.querySelectorAll(".panel").forEach(p=>p.style.display="none");
      document.getElementById("panel-"+tab).style.display="";
      // lazy load
      if(tab==="posts") loadPosts();
      if(tab==="questions") loadQuestions();
      if(tab==="quizzes") loadQuizzes();
      if(tab==="reminders") loadRemindersQuick("today");
      if(tab==="ranking") loadRanking();
      if(tab==="settings") loadSettings();
    });
  });

  // -----------------------
  // init defaults
  // -----------------------
  $("lesson_date").value = toISODate(new Date());

  $("btnClear").addEventListener("click", ()=>{
    $("topic").value = "";
    $("class_name").value = "";
    $("line1").value = "";
    $("line2").value = "";
    $("line3").value = "";
    $("q_title").value = "";
    $("q_body").value = "";
  });

  $("btnPost").addEventListener("click", async ()=>{
    $("btnPost").disabled = true;
    try{
      const payload = {
        name: $("name").value.trim(),
        class_name: $("class_name").value.trim(),
        lesson_date: $("lesson_date").value,
        topic: $("topic").value.trim(),
        line1: $("line1").value.trim(),
        line2: $("line2").value.trim(),
        line3: $("line3").value.trim(),
      };
      // minimal validation
      if(!payload.name || !payload.lesson_date || !payload.line1 || !payload.line2 || !payload.line3){
        alert("åå‰ãƒ»æˆæ¥­æ—¥ãƒ»1ã€œ3è¡Œç›®ã¯å¿…é ˆã§ã™ã€‚");
        return;
      }
      const r = await apiFetch("/api/posts", { method:"POST", body: JSON.stringify(payload) });
      setApiStatus(true, "OK");
      await loadPosts();
      $("badgeCount").textContent = "æŠ•ç¨¿+" + r.id;
    }catch(e){
      console.error(e);
      setApiStatus(false, "NG");
      alert(e.message);
    }finally{
      $("btnPost").disabled = false;
    }
  });

  $("btnLoadPosts").addEventListener("click", loadPosts);

  $("btnAsk").addEventListener("click", async ()=>{
    $("btnAsk").disabled = true;
    try{
      const payload = {
        name: $("name").value.trim(),
        class_name: $("class_name").value.trim(),
        lesson_date: $("lesson_date").value,
        topic: $("topic").value.trim(),
        title: $("q_title").value.trim(),
        body: $("q_body").value.trim(),
      };
      if(!payload.name || !payload.lesson_date || !payload.title || !payload.body){
        alert("åå‰ãƒ»æˆæ¥­æ—¥ãƒ»è³ªå•ã‚¿ã‚¤ãƒˆãƒ«ãƒ»è³ªå•å†…å®¹ã¯å¿…é ˆã§ã™ã€‚");
        return;
      }
      const r = await apiFetch("/api/questions", { method:"POST", body: JSON.stringify(payload) });
      setApiStatus(true, "OK");
      await loadQuestions();
      $("badgeCount").textContent = "è³ªå•+" + r.id;
    }catch(e){
      console.error(e);
      setApiStatus(false, "NG");
      alert(e.message);
    }finally{
      $("btnAsk").disabled = false;
    }
  });

  $("btnLoadQuestions").addEventListener("click", loadQuestions);

  // -----------------------
  // render: posts
  // -----------------------
  async function loadPosts(){
    try{
      const data = await apiFetch("/api/posts?limit=20");
      setApiStatus(true, "OK");
      const list = $("postsList");
      list.innerHTML = "";
      const items = data.items || [];
      $("badgeCount").textContent = items.length + "ä»¶";
      if(items.length===0){
        list.innerHTML = `<div class="item"><div class="small">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div></div>`;
        return;
      }
      for(const p of items){
        list.insertAdjacentHTML("beforeend", `
          <div class="item">
            <div class="meta">
              <span class="tag">ğŸ‘¤ <strong>${escapeHtml(p.name)}</strong></span>
              ${p.class_name ? `<span class="tag">ğŸ« ${escapeHtml(p.class_name)}</span>` : ""}
              ${p.topic ? `<span class="tag">ğŸ§© ${escapeHtml(p.topic)}</span>` : ""}
              <span class="tag">ğŸ“… ${escapeHtml(p.lesson_date)}</span>
              <span class="tag">ğŸ•’ ${escapeHtml(p.created_at || "")}</span>
              <span class="tag">#${escapeHtml(p.id)}</span>
            </div>
            <div class="split">
              <div>1. ${escapeHtml(p.line1)}</div>
              <div>2. ${escapeHtml(p.line2)}</div>
              <div>3. ${escapeHtml(p.line3)}</div>
            </div>
          </div>
        `);
      }
    }catch(e){
      console.error(e);
      setApiStatus(false, "NG");
      $("postsList").innerHTML = `<div class="item"><div class="small">èª­ã¿è¾¼ã¿å¤±æ•—ï¼š${escapeHtml(e.message)}</div></div>`;
    }
  }

  // -----------------------
  // render: questions
  // -----------------------
  async function loadQuestions(){
    try{
      const data = await apiFetch("/api/questions?limit=20");
      setApiStatus(true, "OK");
      const list = $("questionsList");
      list.innerHTML = "";
      const items = data.items || [];
      $("badgeCount").textContent = items.length + "ä»¶";
      if(items.length===0){
        list.innerHTML = `<div class="item"><div class="small">ã¾ã è³ªå•ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div></div>`;
        return;
      }
      for(const q of items){
        const solved = !!q.is_done;
        list.insertAdjacentHTML("beforeend", `
          <div class="item" data-qid="${escapeHtml(q.id)}">
            <div class="meta">
              <span class="tag">ğŸ‘¤ <strong>${escapeHtml(q.name)}</strong></span>
              ${q.class_name ? `<span class="tag">ğŸ« ${escapeHtml(q.class_name)}</span>` : ""}
              ${q.topic ? `<span class="tag">ğŸ§© ${escapeHtml(q.topic)}</span>` : ""}
              <span class="tag">ğŸ“… ${escapeHtml(q.lesson_date)}</span>
              <span class="tag">#${escapeHtml(q.id)}</span>
              <span class="tag">${solved ? "âœ… è§£æ±ºæ¸ˆã¿" : "â“ æœªè§£æ±º"}</span>
            </div>

            <div style="font-weight:800; margin:6px 0 6px;">${escapeHtml(q.title)}</div>
            <div class="small">${escapeHtml(q.body)}</div>

            <div class="answerBox">
              <div class="answerRow" style="margin-bottom:8px;">
                <input type="text" placeholder="å›ç­”è€…åï¼ˆä¾‹ï¼šä¸‰è°·ï¼‰" class="ans_name" />
                <input type="text" placeholder="å›ç­”å†…å®¹ï¼ˆçŸ­ãã¦ã‚‚OKï¼‰" class="ans_body" />
                <button class="secondary btnAnswer">å›ç­”ã™ã‚‹</button>
                <button class="ghost btnLoadAnswers">å›ç­”ã‚’è¡¨ç¤º</button>
                <button class="ghost btnDone" ${solved ? "disabled" : ""}>è§£æ±ºæ¸ˆã¿ã«ã™ã‚‹</button>
              </div>
              <div class="list answersList"></div>
            </div>
          </div>
        `);
      }

      // bind actions
      list.querySelectorAll(".btnAnswer").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const root = btn.closest("[data-qid]");
          const qid = root.getAttribute("data-qid");
          const an = root.querySelector(".ans_name").value.trim() || "åŒ¿å";
          const ab = root.querySelector(".ans_body").value.trim();
          if(!ab){ alert("å›ç­”å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
          btn.disabled = true;
          try{
            await apiFetch(`/api/questions/${encodeURIComponent(qid)}/answers`, {
              method:"POST",
              body: JSON.stringify({ name: an, body: ab })
            });
            root.querySelector(".ans_body").value = "";
            await loadAnswersInto(root, qid);
            setApiStatus(true, "OK");
          }catch(e){
            console.error(e);
            setApiStatus(false, "NG");
            alert(e.message);
          }finally{
            btn.disabled = false;
          }
        });
      });

      list.querySelectorAll(".btnLoadAnswers").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const root = btn.closest("[data-qid]");
          const qid = root.getAttribute("data-qid");
          btn.disabled = true;
          try{
            await loadAnswersInto(root, qid);
            setApiStatus(true, "OK");
          }catch(e){
            console.error(e);
            setApiStatus(false, "NG");
            alert(e.message);
          }finally{
            btn.disabled = false;
          }
        });
      });

      list.querySelectorAll(".btnDone").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const root = btn.closest("[data-qid]");
          const qid = root.getAttribute("data-qid");
          if(!confirm("ã“ã®è³ªå•ã‚’ã€Œè§£æ±ºæ¸ˆã¿ã€ã«ã—ã¾ã™ã‹ï¼Ÿ")) return;
          btn.disabled = true;
          try{
            await apiFetch(`/api/questions/${encodeURIComponent(qid)}/done`, { method:"POST" });
            await loadQuestions();
            setApiStatus(true, "OK");
          }catch(e){
            console.error(e);
            setApiStatus(false, "NG");
            alert(e.message);
            btn.disabled = false;
          }
        });
      });

    }catch(e){
      console.error(e);
      setApiStatus(false, "NG");
      $("questionsList").innerHTML = `<div class="item"><div class="small">èª­ã¿è¾¼ã¿å¤±æ•—ï¼š${escapeHtml(e.message)}</div></div>`;
    }
  }

  async function loadAnswersInto(root, qid){
    const box = root.querySelector(".answersList");
    box.innerHTML = `<div class="item"><div class="small">èª­ã¿è¾¼ã¿ä¸­...</div></div>`;
    const data = await apiFetch(`/api/questions/${encodeURIComponent(qid)}/answers?limit=20`);
    const items = data.items || [];
    if(items.length===0){
      box.innerHTML = `<div class="item"><div class="small">ã¾ã å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div></div>`;
      return;
    }
    box.innerHTML = "";
    for(const a of items){
      box.insertAdjacentHTML("beforeend", `
        <div class="item">
          <div class="meta">
            <span class="tag">ğŸ—£ï¸ <strong>${escapeHtml(a.name)}</strong></span>
            <span class="tag">ğŸ•’ ${escapeHtml(a.created_at || "")}</span>
            <span class="tag">#${escapeHtml(a.id)}</span>
          </div>
          <div>${escapeHtml(a.body)}</div>
        </div>
      `);
    }
  }

  // -----------------------
  // quizzes
  // -----------------------
  async function loadQuizzes(){
    try{
      const data = await apiFetch("/api/quizzes?limit=20");
      setApiStatus(true, "OK");
      const list = $("quizzesList");
      list.innerHTML = "";
      const items = data.items || [];
      $("badgeCount").textContent = items.length + "ä»¶";
      if(items.length===0){
        list.innerHTML = `<div class="item"><div class="small">ã‚¯ã‚¤ã‚ºã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div></div>`;
        return;
      }
      for(const q of items){
        list.insertAdjacentHTML("beforeend", `
          <div class="item">
            <div class="meta">
              <span class="tag">ğŸ‘¤ <strong>${escapeHtml(q.name || "")}</strong></span>
              ${q.topic ? `<span class="tag">ğŸ§© ${escapeHtml(q.topic)}</span>` : ""}
              ${q.lesson_date ? `<span class="tag">ğŸ“… ${escapeHtml(q.lesson_date)}</span>` : ""}
              ${q.due_date ? `<span class="tag">â° ${escapeHtml(q.due_date)}</span>` : ""}
              ${q.kind ? `<span class="tag">ğŸ§  ${escapeHtml(q.kind)}</span>` : ""}
              ${q.id ? `<span class="tag">#${escapeHtml(q.id)}</span>` : ""}
            </div>
            <div style="font-weight:800; margin-bottom:6px;">${escapeHtml(q.question || q.title || "Quiz")}</div>
            ${q.options ? `<div class="small">é¸æŠè‚¢ï¼š${escapeHtml(q.options)}</div>` : ""}
            ${q.answer ? `<div class="small">ç­”ãˆï¼š${escapeHtml(q.answer)}</div>` : ""}
          </div>
        `);
      }
    }catch(e){
      console.error(e);
      setApiStatus(false, "NG");
      $("quizzesList").innerHTML = `<div class="item"><div class="small">èª­ã¿è¾¼ã¿å¤±æ•—ï¼š${escapeHtml(e.message)}</div></div>`;
    }
  }

  // -----------------------
  // reminders
  // -----------------------
  async function loadRemindersQuick(mode){
    try{
      const name = $("name").value.trim();
      const base = new Date();
      let due = new Date(base);
      if(mode==="tomorrow") due.setDate(due.getDate()+1);
      if(mode==="week") due.setDate(due.getDate()+7);
      // today => +1 day? ä½ ä¹‹å‰æˆªå›¾é‡Œ due è¿”å›çš„æ˜¯æ˜å¤©ï¼ˆ2025-12-28ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åšä¸¤ç§ï¼š
      // - â€œä»Šæ—¥â€ï¼šå–æ˜å¤©çš„ dueï¼ˆæˆæ¥­ç¿Œæ—¥ï¼‰
      // - â€œæ˜æ—¥â€ï¼šå–åå¤©
      // - â€œ7æ—¥å¾Œâ€ï¼šå– 7 å¤©å
      if(mode==="today") due.setDate(due.getDate()+1);
      if(mode==="tomorrow") due.setDate(due.getDate()+2);
      const dueStr = toISODate(due);

      const data = await apiFetch(`/api/reminders?name=${encodeURIComponent(name)}&due=${encodeURIComponent(dueStr)}&limit=50`);
      setApiStatus(true, "OK");
      const list = $("remindersList");
      list.innerHTML = "";
      const items = data.items || [];
      $("badgeCount").textContent = items.length + "ä»¶";
      if(items.length===0){
        list.innerHTML = `<div class="item"><div class="small">ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ï¼ˆdue=${escapeHtml(dueStr)}ï¼‰</div></div>`;
        return;
      }
      for(const r of items){
        list.insertAdjacentHTML("beforeend", `
          <div class="item">
            <div class="meta">
              <span class="tag">ğŸ‘¤ <strong>${escapeHtml(r.name)}</strong></span>
              ${r.topic ? `<span class="tag">ğŸ§© ${escapeHtml(r.topic)}</span>` : ""}
              <span class="tag">ğŸ“… due ${escapeHtml(r.due_date || dueStr)}</span>
              ${r.lesson_date ? `<span class="tag">æˆæ¥­ ${escapeHtml(r.lesson_date)}</span>` : ""}
              ${r.post_id ? `<span class="tag">post #${escapeHtml(r.post_id)}</span>` : ""}
              ${r.id ? `<span class="tag">#${escapeHtml(r.id)}</span>` : ""}
            </div>
            <div style="font-weight:800; margin-bottom:6px;">${escapeHtml(r.title || "å¾©ç¿’ã—ã¾ã—ã‚‡ã†")}</div>
            <div class="small">${escapeHtml(r.body || "")}</div>
          </div>
        `);
      }
    }catch(e){
      console.error(e);
      setApiStatus(false, "NG");
      $("remindersList").innerHTML = `<div class="item"><div class="small">èª­ã¿è¾¼ã¿å¤±æ•—ï¼š${escapeHtml(e.message)}</div></div>`;
    }
  }

  // -----------------------
  // ranking
  // -----------------------
  async function loadRanking(){
    try{
      const data = await apiFetch("/api/ranking");
      setApiStatus(true, "OK");
      const list = $("rankingList");
      list.innerHTML = "";
      const posts = data.posts || [];
      const answers = data.answers || [];
      $("badgeCount").textContent = (posts.length + answers.length) + "ä»¶";

      list.insertAdjacentHTML("beforeend", `
        <div class="item">
          <div style="font-weight:800; margin-bottom:8px;">æŠ•ç¨¿æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
          ${posts.length ? posts.map((x,i)=>`<div>${i+1}. ${escapeHtml(x.name)}ï¼š<strong>${escapeHtml(x.count)}</strong></div>`).join("") : `<div class="small">ãƒ‡ãƒ¼ã‚¿ãªã—</div>`}
        </div>
      `);

      list.insertAdjacentHTML("beforeend", `
        <div class="item">
          <div style="font-weight:800; margin-bottom:8px;">å›ç­”æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
          ${answers.length ? answers.map((x,i)=>`<div>${i+1}. ${escapeHtml(x.name)}ï¼š<strong>${escapeHtml(x.count)}</strong></div>`).join("") : `<div class="small">ãƒ‡ãƒ¼ã‚¿ãªã—</div>`}
        </div>
      `);

    }catch(e){
      console.error(e);
      setApiStatus(false, "NG");
      $("rankingList").innerHTML = `<div class="item"><div class="small">èª­ã¿è¾¼ã¿å¤±æ•—ï¼š${escapeHtml(e.message)}</div></div>`;
    }
  }

  // -----------------------
  // settings
  // -----------------------
  async function loadSettings(){
    try{
      const data = await apiFetch("/api/settings");
      setApiStatus(true, "OK");
      const show = (data.show_ranking ?? 1) ? "1" : "0";
      $("set_showRanking").value = String(show);
      $("set_defaultClass").value = data.default_class || "";
    }catch(e){
      console.error(e);
      setApiStatus(false, "NG");
      // settings is optional; don't alert spam
    }
  }

  async function saveSettings(){
    try{
      const payload = {
        show_ranking: Number($("set_showRanking").value),
        default_class: $("set_defaultClass").value.trim()
      };
      const data = await apiFetch("/api/settings", { method:"POST", body: JSON.stringify(payload) });
      setApiStatus(true, "OK");
      alert("ä¿å­˜ã—ã¾ã—ãŸ");
      // apply default class to input if empty
      if(!$("class_name").value.trim() && payload.default_class){
        $("class_name").value = payload.default_class;
      }
      return data;
    }catch(e){
      console.error(e);
      setApiStatus(false, "NG");
      alert(e.message);
    }
  }

  // -----------------------
  // boot: quick health + initial list
  // -----------------------
  (async ()=>{
    try{
      const h = await apiFetch("/api/health");
      setApiStatus(true, "OK");
      // initial load posts
      await loadPosts();
      // apply settings if available
      await loadSettings();
      const def = $("set_defaultClass").value.trim();
      if(def) $("class_name").value = def;
    }catch(e){
      console.error(e);
      setApiStatus(false, "NG");
    }
  })();
</script>
</body>
</html>
