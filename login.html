<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ログイン</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#1f5eff" />

  <style>
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:#f5f7fb}
    .hero{background:linear-gradient(135deg,#1f5eff,#2b7cff);color:#fff;padding:40px 20px}
    .wrap{max-width:980px;margin:0 auto}
    .title{font-size:44px;font-weight:800;letter-spacing:.02em;margin:0}
    .sub{opacity:.9;margin-top:8px}
    .card{max-width:760px;margin:-28px auto 24px;background:#fff;border-radius:18px;box-shadow:0 12px 30px rgba(0,0,0,.08);padding:22px}
    .row{display:grid;grid-template-columns:1fr;gap:14px}
    label{font-size:13px;color:#334155}
    input{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;font-size:16px;outline:none}
    input:focus{border-color:#1f5eff;box-shadow:0 0 0 3px rgba(31,94,255,.15)}
    .btns{display:flex;gap:12px;align-items:center;margin-top:10px}
    button{border:0;border-radius:12px;padding:12px 16px;font-weight:700;font-size:15px;cursor:pointer}
    .primary{background:#1f5eff;color:#fff}
    .primary:hover{filter:brightness(.95)}
    .ghost{background:#eef2ff;color:#1f5eff}
    .msg{margin-top:12px;padding:10px 12px;border-radius:12px;background:#0b1220;color:#e5e7eb;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;font-size:12.5px;white-space:pre-wrap}
    .toplink{color:#fff;text-decoration:none;font-weight:700}
  </style>
</head>

<body>
  <div class="hero">
    <div class="wrap">
      <a class="toplink" href="/">← メニュー</a>
      <h1 class="title">ログイン</h1>
      <div class="sub">管理者が発行したアカウントでログインしてください。</div>
    </div>
  </div>

  <div class="card">
    <form id="form" class="row">
      <div>
        <label>ユーザー名（username）</label>
        <input id="username" autocomplete="username" required />
      </div>
      <div>
        <label>パスワード</label>
        <input id="password" type="password" autocomplete="current-password" required />
      </div>

      <div class="btns">
        <button class="primary" type="submit">ログイン</button>
        <button class="ghost" type="button" id="btnMe">/api/auth/me 確認</button>
      </div>

      <div id="msg" class="msg" style="display:none"></div>
    </form>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const msg = (t) => { $("msg").style.display="block"; $("msg").textContent = t; };

    function getNext() {
      const u = new URL(location.href);
      const next = u.searchParams.get("next");
      return next && next.startsWith("/") ? next : "/index.html";
    }

    async function api(path, opts = {}) {
      const res = await fetch(path, {
        ...opts,
        credentials: "include",
        cache: "no-store",
        headers: { "Content-Type": "application/json", ...(opts.headers || {}) },
      });
      let data = null;
      try { data = await res.json(); } catch (_) {}
      return { res, data };
    }

    $("btnMe").addEventListener("click", async () => {
      const r = await api("/api/auth/me");
      msg(`GET /api/auth/me\nHTTP ${r.res.status}\n${JSON.stringify(r.data)}`);
    });

    $("form").addEventListener("submit", async (e) => {
      e.preventDefault();
      $("msg").style.display="none";

      const username = $("username").value.trim();
      const password = $("password").value;

      const r = await api("/api/auth/login", {
        method: "POST",
        body: JSON.stringify({ username, password }),
      });

      if (!r.res.ok || !r.data || r.data.ok !== true) {
        msg(`LOGIN FAIL\nHTTP ${r.res.status}\n${JSON.stringify(r.data)}`);
        return;
      }

      // 立刻再确认一次 me，确保 cookie/session 真生效
      const me = await api("/api/auth/me");
      if (!me.data || !me.data.user) {
        msg(`ログイン直後の /api/auth/me で user が取れません。\nHTTP ${me.res.status}\n${JSON.stringify(me.data)}`);
        return;
      }

      // 强制绕开缓存：加时间戳
      const next = getNext();
      const sep = next.includes("?") ? "&" : "?";
      location.replace(next + sep + "v=" + Date.now());
    });
  </script>
</body>
</html>
