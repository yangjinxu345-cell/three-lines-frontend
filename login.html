<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ログイン</title>
  <style>
    :root{--blue:#1e5eff;--bg:#f5f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:var(--bg);color:var(--text);}
    header{background:linear-gradient(135deg,#1e5eff,#0ea5e9);padding:28px 18px;color:#fff;}
    header h1{margin:0;font-size:28px;letter-spacing:.5px}
    header p{margin:6px 0 0;opacity:.9}
    main{max-width:860px;margin:-28px auto 32px;padding:0 18px;}
    .card{background:var(--card);border-radius:16px;box-shadow:0 12px 30px rgba(15,23,42,.08);padding:22px;}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .field{flex:1;min-width:240px}
    label{display:block;font-weight:700;margin:10px 0 8px}
    input{width:100%;box-sizing:border-box;border:1px solid #e2e8f0;border-radius:12px;padding:12px 14px;font-size:16px;outline:none}
    input:focus{border-color:#93c5fd;box-shadow:0 0 0 4px rgba(59,130,246,.15)}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer}
    .btnPrimary{background:var(--blue);color:#fff}
    .btnPrimary:hover{filter:brightness(.95)}
    .hint{color:var(--muted);font-size:13px;margin-top:6px}
    .out{margin-top:14px;color:#b91c1c;font-weight:700;white-space:pre-wrap}
    .topbar{display:flex;justify-content:flex-end;margin-bottom:10px}
    .link{color:#fff;text-decoration:none;font-weight:800;opacity:.95}
    .link:hover{opacity:1;text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="link" href="/index.html">← メニュー</a>
    </div>
    <h1>ログイン</h1>
    <p>アカウントでログインしてください。</p>
  </header>

  <main>
    <div class="card">
      <div class="row">
        <div class="field">
          <label>ユーザー名</label>
          <input id="username" autocomplete="username" placeholder="例：01252016" />
          <div class="hint">学籍番号など</div>
        </div>
        <div class="field">
          <label>パスワード</label>
          <input id="password" type="password" autocomplete="current-password" placeholder="パスワード" />
          <div class="hint">初期は学籍番号（例：01252016）</div>
        </div>
      </div>

      <div style="margin-top:16px;display:flex;gap:10px;align-items:center;">
        <button id="btnLogin" class="btn btnPrimary">ログイン</button>
        <span id="status" class="hint"></span>
      </div>

      <div id="out" class="out"></div>
    </div>
  </main>

  <script>
    const $ = (id)=>document.getElementById(id);

    function getNext() {
      const u = new URL(location.href);
      const n = u.searchParams.get("next");
      // 防御：next が /login 系なら無視してメニューへ
      if (!n) return "/index.html";
      if (n.startsWith("/login")) return "/index.html";
      return n;
    }

    async function api(path, opt={}) {
      const res = await fetch(path, {
        cache: "no-store",
        credentials: "include",
        headers: { "Content-Type":"application/json", ...(opt.headers||{}) },
        ...opt,
      });
      const json = await res.json().catch(()=>null);
      return { res, json };
    }

    async function doLogin() {
      $("out").textContent = "";
      $("status").textContent = "ログイン中…";
      $("btnLogin").disabled = true;

      try{
        const username = $("username").value.trim();
        const password = $("password").value;

        if(!username || !password){
          throw new Error("ユーザー名とパスワードを入力してください。");
        }

        const r = await api("/api/auth/login", {
          method:"POST",
          body: JSON.stringify({ username, password })
        });

        if(!r.res.ok || !r.json || r.json.ok !== true){
          throw new Error((r.json && r.json.error) ? r.json.error : `HTTP ${r.res.status}`);
        }

        // ここで /api/auth/me を叩いて「セッションが有効」になったことを確認してから遷移
        const me = await api("/api/auth/me", { method:"GET" });
        if(!me.json || !me.json.ok || !me.json.user){
          throw new Error("ログイン後のセッション確認に失敗しました（/api/auth/me）。");
        }

        location.replace(getNext());
      }catch(e){
        $("out").textContent = String(e?.message || e);
      }finally{
        $("status").textContent = "";
        $("btnLogin").disabled = false;
      }
    }

    $("btnLogin").addEventListener("click", doLogin);
    $("password").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
  </script>
</body>
</html>
