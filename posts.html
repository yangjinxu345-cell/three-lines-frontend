<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>3è¡ŒæŠ•ç¨¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                   Roboto, "Helvetica Neue", Arial;
      background: #f5f7fb;
      margin: 0;
      padding: 24px;
    }

    h1 { margin-bottom: 12px; }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
    }

    input, textarea, button, select {
      width: 100%;
      margin-top: 6px;
      padding: 10px;
      font-size: 14px;
      box-sizing: border-box;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    button {
      margin-top: 16px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover { background: #1d4ed8; }

    .post {
      border-top: 1px solid #eee;
      padding: 12px 0;
    }

    .meta {
      color: #555;
      font-size: 13px;
      margin-bottom: 6px;
    }

    .lines li { margin-left: 18px; }

    .status {
      margin-bottom: 12px;
      font-size: 14px;
      color: #0b5ed7;
    }

    pre {
      background: #111;
      color: #0f0;
      padding: 10px;
      overflow-x: auto;
      font-size: 12px;
      border-radius: 10px;
    }

    .nav { margin-bottom: 16px; }
    .nav a { text-decoration: none; color: #2563eb; }

    /* ====== teacher mode ====== */
    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .row > * { flex: 1; min-width: 220px; }
    .mini {
      font-size: 12px;
      color: #666;
      margin-top: 6px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      background: #f9fafb;
      font-size: 13px;
      color: #111;
    }
    .switch {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .switch input { width: auto; margin: 0; }
    .warn { color: #b45309; font-size: 13px; }
    .err { color: #b91c1c; font-size: 13px; }
    .ok { color: #15803d; font-size: 13px; }

    /* ====== actions ====== */
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
      align-items: center;
    }
    .btn2 {
      width: auto;
      margin: 0;
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 600;
      background: #2563eb;
      border: 0;
      color: #fff;
    }
    .btn2.gray { background: #374151; }
    .btn2.red { background: #dc2626; }
    .btn2:disabled { opacity: .5; cursor: not-allowed; }

    .count {
      font-size: 13px;
      color: #374151;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
    }

    /* ====== comments ====== */
    .comments {
      margin-top: 12px;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #fbfdff;
    }
    .commentItem {
      padding: 10px 0;
      border-top: 1px solid #eef2f7;
    }
    .commentItem:first-child { border-top: 0; }
    .commentMeta {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .commentBody {
      font-size: 14px;
      color: #111827;
      white-space: pre-wrap;
      line-height: 1.5;
    }
    .commentEdit textarea { min-height: 70px; }
    .inlineBtns { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .inlineBtns button { margin-top:0; }

    .muted { color: #6b7280; font-size: 13px; }
  </style>
</head>
<body>

  <div class="nav">
    <a href="index.html">â† æˆ»ã‚‹ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰</a>
  </div>

  <h1>3è¡ŒæŠ•ç¨¿</h1>

  <!-- æ•™å“¡ãƒ¢ãƒ¼ãƒ‰ -->
  <div class="card">
    <h2 style="margin-top:0">æ•™å“¡ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆã„ã„ã­ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆï¼‰</h2>

    <div class="row">
      <div>
        <div class="pill">
          <label class="switch" style="margin:0;font-weight:600">
            <input type="checkbox" id="teacherMode" />
            æ•™å“¡ãƒ¢ãƒ¼ãƒ‰
          </label>
          <span id="teacherModeState" class="muted">OFF</span>
        </div>
        <div class="mini">â€» æ•™å“¡ãƒ¢ãƒ¼ãƒ‰ONã§ã€Œã„ã„ã­/ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã€ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</div>
      </div>

      <div>
        <label style="margin-top:0">æ•™å“¡åï¼ˆteacher_nameï¼‰</label>
        <input id="teacherName" placeholder="ä¾‹ï¼šä¸‰è°·" />
      </div>

      <div>
        <label style="margin-top:0">æ•™å“¡ã‚­ãƒ¼ï¼ˆteacher_keyï¼‰</label>
        <input id="teacherKey" placeholder="è¨­å®šã§ç®¡ç†ã—ã¦ã„ã‚‹ã‚­ãƒ¼" />
        <div class="mini">â€» localStorage ã«ä¿å­˜ã—ã¾ã™ï¼ˆåŒã˜PC/ãƒ–ãƒ©ã‚¦ã‚¶ã§ä¿æŒï¼‰ã€‚</div>
      </div>
    </div>

    <div class="actions" style="margin-top:12px">
      <button class="btn2 gray" id="btnSaveTeacher">ä¿å­˜</button>
      <button class="btn2 red" id="btnClearTeacher">ã‚¯ãƒªã‚¢</button>
      <span id="teacherMsg" class="muted"></span>
    </div>
  </div>

  <!-- æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="card">
    <h2>æ–°ã—ã„æŠ•ç¨¿</h2>

    <label>åå‰</label>
    <input id="name" placeholder="ä¾‹ï¼šæ¥Šæ—»" />

    <label>ã‚¯ãƒ©ã‚¹</label>
    <input id="class_name" placeholder="ä¾‹ï¼šITE2" />

    <label>æˆæ¥­æ—¥</label>
    <input id="lesson_date" type="date" />

    <label>æˆæ¥­å / ãƒ†ãƒ¼ãƒ</label>
    <input id="topic" placeholder="ä¾‹ï¼šSQL å¤–éƒ¨çµåˆ" />

    <label>1è¡Œç›®</label>
    <textarea id="line1"></textarea>

    <label>2è¡Œç›®</label>
    <textarea id="line2"></textarea>

    <label>3è¡Œç›®</label>
    <textarea id="line3"></textarea>

    <button id="submitBtn">æŠ•ç¨¿ã™ã‚‹</button>

    <pre id="result"></pre>
  </div>

  <!-- æŠ•ç¨¿ä¸€è¦§ -->
  <div class="card">
    <h2>æŠ•ç¨¿ä¸€è¦§</h2>
    <div class="status" id="status">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    <div id="list"></div>
  </div>

<script>
/* ===============================
   å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
================================ */
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

function fmtCount(v){
  const n = Number(v);
  if (Number.isFinite(n)) return n;
  return 0;
}

function nowIso(){
  return new Date().toISOString();
}

function getTeacherState(){
  return {
    enabled: document.getElementById("teacherMode").checked,
    name: (document.getElementById("teacherName").value || "").trim(),
    key: (document.getElementById("teacherKey").value || "").trim(),
  };
}

function applyTeacherStateToUI(){
  const st = getTeacherState();
  const stateEl = document.getElementById("teacherModeState");
  stateEl.textContent = st.enabled ? "ON" : "OFF";
  stateEl.className = st.enabled ? "ok" : "muted";
}

function showTeacherMsg(text, kind="muted"){
  const el = document.getElementById("teacherMsg");
  el.textContent = text;
  el.className = kind;
}

async function api(url, options = {}) {
  const headers = {
    "Content-Type": "application/json",
    ...(options.headers || {})
  };

  // æ•™å“¡æ“ä½œã¯ãƒ˜ãƒƒãƒ€ã«ã‚­ãƒ¼ã‚’ä»˜ä¸ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
  const t = getTeacherState();
  if (t.key) headers["X-Teacher-Key"] = t.key;

  const res = await fetch(url, { ...options, headers });
  const text = await res.text();
  let data;
  try { data = JSON.parse(text); } catch { data = text; }

  if (!res.ok) {
    throw new Error(`HTTP ${res.status} ${text}`);
  }
  if (data && typeof data === "object" && data.ok === false) {
    throw new Error(data.error || "API error");
  }
  return data;
}

/* ===============================
   æŠ•ç¨¿ä¸€è¦§ã®å–å¾—
================================ */
async function refreshPosts() {
  const status = document.getElementById("status");
  const list = document.getElementById("list");

  status.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";
  list.innerHTML = "";

  try {
    const data = await api("/api/posts?limit=20");
    if (!data.ok) {
      status.textContent = "å–å¾—å¤±æ•—";
      return;
    }
    status.textContent = `å–å¾—ä»¶æ•°ï¼š${data.items.length}`;
    for (const p of data.items) {
      list.appendChild(renderPost(p));
    }
    applyTeacherStateToUI();
  } catch (e) {
    status.textContent = "ã‚¨ãƒ©ãƒ¼ï¼ˆConsole ã‚’ç¢ºèªï¼‰";
    console.error(e);
  }
}

/* ===============================
   1ä»¶æç”»ï¼ˆã„ã„ã­ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆUIä»˜ãï¼‰
================================ */
function renderPost(p) {
  const div = document.createElement("div");
  div.className = "post";
  div.dataset.postId = String(p.id);

  const likeCount = fmtCount(p.like_count ?? p.likeCount ?? 0);
  const commentCount = fmtCount(p.comment_count ?? p.commentCount ?? 0);

  div.innerHTML = `
    <div class="meta">
      ğŸ‘¤ ${escapeHtml(p.name || "?")}
      ï½œğŸ« ${escapeHtml(p.class_name || "-")}
      ï½œğŸ“… ${escapeHtml(p.lesson_date || "-")}
      ï½œğŸ•’ ${escapeHtml(p.created_at || "-")}
    </div>
    <div><strong>${escapeHtml(p.topic || "")}</strong></div>
    <ol class="lines">
      <li>${escapeHtml(p.line1 || "")}</li>
      <li>${escapeHtml(p.line2 || "")}</li>
      <li>${escapeHtml(p.line3 || "")}</li>
    </ol>

    <div class="actions">
      <span class="count" title="ã„ã„ã­æ•°">ğŸ‘ <span class="likeCount">${likeCount}</span></span>
      <span class="count" title="ã‚³ãƒ¡ãƒ³ãƒˆæ•°">ğŸ’¬ <span class="commentCount">${commentCount}</span></span>

      <button class="btn2 gray btnToggleComments">ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹</button>

      <button class="btn2 btnLike" disabled>ã„ã„ã­</button>
      <button class="btn2 gray btnUnlike" disabled>å–æ¶ˆ</button>

      <span class="muted lastCommented">${p.last_commented_at ? ("æœ€çµ‚ã‚³ãƒ¡ãƒ³ãƒˆ: " + escapeHtml(p.last_commented_at)) : ""}</span>
    </div>

    <div class="comments" style="display:none">
      <div class="muted commentsStatus">ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã™â€¦</div>
      <div class="commentList"></div>

      <div class="commentNew" style="margin-top:12px;display:none">
        <label style="font-weight:700;margin-top:0">æ•™å“¡ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ </label>
        <textarea class="newBody" placeholder="å…ˆç”Ÿã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
        <div class="inlineBtns">
          <button class="btn2 btnAddComment">ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿</button>
        </div>
        <div class="mini">â€» æ•™å“¡ãƒ¢ãƒ¼ãƒ‰ON & æ•™å“¡å/ã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚</div>
      </div>

      <div class="err commentErr" style="margin-top:10px;display:none"></div>
    </div>
  `;

  // attach behaviors
  wirePostActions(div, p);
  return div;
}

function wirePostActions(div, p){
  const postId = Number(p.id);
  const btnToggle = div.querySelector(".btnToggleComments");
  const commentsBox = div.querySelector(".comments");
  const commentsStatus = div.querySelector(".commentsStatus");
  const commentList = div.querySelector(".commentList");
  const commentNew = div.querySelector(".commentNew");
  const commentErr = div.querySelector(".commentErr");

  const btnLike = div.querySelector(".btnLike");
  const btnUnlike = div.querySelector(".btnUnlike");
  const likeCountEl = div.querySelector(".likeCount");
  const commentCountEl = div.querySelector(".commentCount");
  const lastCommentedEl = div.querySelector(".lastCommented");

  function updateTeacherButtons(){
    const t = getTeacherState();
    const ok = t.enabled && t.name && t.key;
    btnLike.disabled = !ok;
    btnUnlike.disabled = !ok;
    commentNew.style.display = ok ? "" : "none";
  }

  updateTeacherButtons();

  // Toggle comments
  btnToggle.addEventListener("click", async () => {
    const shown = commentsBox.style.display !== "none";
    if (shown) {
      commentsBox.style.display = "none";
      btnToggle.textContent = "ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹";
      return;
    }
    commentsBox.style.display = "";
    btnToggle.textContent = "é–‰ã˜ã‚‹";
    commentErr.style.display = "none";
    commentErr.textContent = "";

    // load comments
    commentsStatus.textContent = "ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­â€¦";
    commentList.innerHTML = "";
    try{
      const data = await api(`/api/posts/${postId}/comments`);
      const items = data.items ?? data.comments ?? data.results ?? [];
      if (items.length === 0) {
        commentsStatus.textContent = "ã‚³ãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚";
      } else {
        commentsStatus.textContent = `ã‚³ãƒ¡ãƒ³ãƒˆï¼š${items.length}ä»¶`;
      }
      renderComments(commentList, items, postId, {
        onCountsChanged: (newCount, newLastAt) => {
          commentCountEl.textContent = String(newCount);
          if (newLastAt) lastCommentedEl.textContent = "æœ€çµ‚ã‚³ãƒ¡ãƒ³ãƒˆ: " + newLastAt;
        }
      });
    }catch(e){
      commentsStatus.textContent = "ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼";
      commentErr.style.display = "";
      commentErr.textContent = String(e?.message || e);
    }

    updateTeacherButtons();
  });

  // Like
  btnLike.addEventListener("click", async () => {
    const t = getTeacherState();
    commentErr.style.display = "none";
    commentErr.textContent = "";
    btnLike.disabled = true;
    try{
      const data = await api(`/api/posts/${postId}/like`, {
        method: "POST",
        body: JSON.stringify({ teacher_name: t.name })
      });
      // expect: { ok:true, like_count: n } or similar
      const newCount = fmtCount(data.like_count ?? data.likeCount ?? data.count ?? data.value ?? likeCountEl.textContent);
      likeCountEl.textContent = String(newCount);
      showTeacherMsg("ã„ã„ã­ã—ã¾ã—ãŸ", "ok");
    }catch(e){
      commentErr.style.display = "";
      commentErr.textContent = String(e?.message || e);
    }finally{
      updateTeacherButtons();
    }
  });

  // Unlike
  btnUnlike.addEventListener("click", async () => {
    const t = getTeacherState();
    commentErr.style.display = "none";
    commentErr.textContent = "";
    btnUnlike.disabled = true;
    try{
      const data = await api(`/api/posts/${postId}/like?teacher_name=${encodeURIComponent(t.name)}`, {
        method: "DELETE"
      });
      const newCount = fmtCount(data.like_count ?? data.likeCount ?? data.count ?? data.value ?? likeCountEl.textContent);
      likeCountEl.textContent = String(newCount);
      showTeacherMsg("ã„ã„ã­ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ", "ok");
    }catch(e){
      commentErr.style.display = "";
      commentErr.textContent = String(e?.message || e);
    }finally{
      updateTeacherButtons();
    }
  });

  // Add comment
  div.querySelector(".btnAddComment").addEventListener("click", async () => {
    const t = getTeacherState();
    const bodyEl = div.querySelector(".newBody");
    const body = (bodyEl.value || "").trim();
    commentErr.style.display = "none";
    commentErr.textContent = "";

    if (!(t.enabled && t.name && t.key)) {
      commentErr.style.display = "";
      commentErr.textContent = "æ•™å“¡ãƒ¢ãƒ¼ãƒ‰ONã€æ•™å“¡åã¨æ•™å“¡ã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚";
      return;
    }
    if (!body) {
      commentErr.style.display = "";
      commentErr.textContent = "ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ãŒç©ºã§ã™ã€‚";
      return;
    }

    const btn = div.querySelector(".btnAddComment");
    btn.disabled = true;
    try{
      const data = await api(`/api/posts/${postId}/comments`, {
        method: "POST",
        body: JSON.stringify({ teacher_name: t.name, body })
      });
      bodyEl.value = "";

      // reload comments for correctness
      const data2 = await api(`/api/posts/${postId}/comments`);
      const items = data2.items ?? data2.comments ?? data2.results ?? [];
      div.querySelector(".commentList").innerHTML = "";
      renderComments(div.querySelector(".commentList"), items, postId, {
        onCountsChanged: (newCount, newLastAt) => {
          commentCountEl.textContent = String(newCount);
          if (newLastAt) lastCommentedEl.textContent = "æœ€çµ‚ã‚³ãƒ¡ãƒ³ãƒˆ: " + newLastAt;
        }
      });

      const newCount = fmtCount(data.comment_count ?? data.commentCount ?? items.length);
      commentCountEl.textContent = String(newCount);
      lastCommentedEl.textContent = "æœ€çµ‚ã‚³ãƒ¡ãƒ³ãƒˆ: " + (data.last_commented_at ?? nowIso());
      showTeacherMsg("ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ", "ok");
    }catch(e){
      commentErr.style.display = "";
      commentErr.textContent = String(e?.message || e);
    }finally{
      btn.disabled = false;
    }
  });

  // Teacher mode changes should update buttons
  document.getElementById("teacherMode").addEventListener("change", updateTeacherButtons);
  document.getElementById("teacherName").addEventListener("input", updateTeacherButtons);
  document.getElementById("teacherKey").addEventListener("input", updateTeacherButtons);
}

/* ===============================
   ã‚³ãƒ¡ãƒ³ãƒˆæç”»ï¼ˆç·¨é›†/å‰Šé™¤ã¤ãï¼‰
================================ */
function renderComments(container, items, postId, { onCountsChanged } = {}){
  const t = getTeacherState();
  const enabled = t.enabled && t.name && t.key;

  let lastAt = "";
  for (const c of items) {
    if (c.created_at && (!lastAt || c.created_at > lastAt)) lastAt = c.created_at;
  }
  if (onCountsChanged) onCountsChanged(items.length, lastAt);

  items.forEach(c => {
    const mine = enabled && (String(c.teacher_name || "") === String(t.name));
    const wrap = document.createElement("div");
    wrap.className = "commentItem";
    wrap.dataset.commentId = String(c.id);

    wrap.innerHTML = `
      <div class="commentMeta">
        <div>ğŸ‘©â€ğŸ« ${escapeHtml(c.teacher_name || "?")} ï½œ ğŸ•’ ${escapeHtml(c.created_at || "-")}${c.updated_at ? (" ï½œ âœï¸ " + escapeHtml(c.updated_at)) : ""}</div>
        <div class="inlineBtns" style="margin-top:0">
          ${mine ? `<button class="btn2 gray btnEdit">ç·¨é›†</button>` : ``}
          ${mine ? `<button class="btn2 red btnDelete">å‰Šé™¤</button>` : ``}
        </div>
      </div>

      <div class="commentBody">${escapeHtml(c.body || "")}</div>

      <div class="commentEdit" style="display:none">
        <label style="font-weight:700;margin-top:8px">ç·¨é›†</label>
        <textarea class="editBody"></textarea>
        <div class="inlineBtns">
          <button class="btn2 btnSaveEdit">ä¿å­˜</button>
          <button class="btn2 gray btnCancelEdit">å–æ¶ˆ</button>
        </div>
      </div>
    `;

    container.appendChild(wrap);

    if (!mine) return;

    const btnEdit = wrap.querySelector(".btnEdit");
    const btnDelete = wrap.querySelector(".btnDelete");
    const editBox = wrap.querySelector(".commentEdit");
    const bodyDiv = wrap.querySelector(".commentBody");
    const editTa = wrap.querySelector(".editBody");
    const btnSave = wrap.querySelector(".btnSaveEdit");
    const btnCancel = wrap.querySelector(".btnCancelEdit");

    btnEdit.addEventListener("click", () => {
      editTa.value = (c.body || "");
      editBox.style.display = "";
      bodyDiv.style.display = "none";
    });

    btnCancel.addEventListener("click", () => {
      editBox.style.display = "none";
      bodyDiv.style.display = "";
    });

    btnSave.addEventListener("click", async () => {
      const st = getTeacherState();
      const newBody = (editTa.value || "").trim();
      if (!newBody) {
        alert("æœ¬æ–‡ãŒç©ºã§ã™ã€‚");
        return;
      }
      btnSave.disabled = true;
      try{
        const data = await api(`/api/comments/${c.id}`, {
          method: "PUT",
          body: JSON.stringify({ teacher_name: st.name, body: newBody })
        });
        // update UI
        c.body = newBody;
        c.updated_at = data.updated_at ?? nowIso();
        bodyDiv.textContent = newBody;
        editBox.style.display = "none";
        bodyDiv.style.display = "";
        showTeacherMsg("ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ", "ok");
      }catch(e){
        alert(String(e?.message || e));
      }finally{
        btnSave.disabled = false;
      }
    });

    btnDelete.addEventListener("click", async () => {
      const st = getTeacherState();
      if (!confirm("ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆå¾©å…ƒä¸å¯ï¼‰")) return;
      btnDelete.disabled = true;
      try{
        await api(`/api/comments/${c.id}?teacher_name=${encodeURIComponent(st.name)}`, {
          method: "DELETE"
        });
        wrap.remove();
        // counts will be re-evaluated by caller after reload; but we can do a quick decrement
        showTeacherMsg("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ", "ok");
      }catch(e){
        alert(String(e?.message || e));
      }finally{
        btnDelete.disabled = false;
      }
    });
  });
}

/* ===============================
   æŠ•ç¨¿å‡¦ç†
================================ */
document.getElementById("submitBtn").addEventListener("click", async () => {
  const body = {
    name: document.getElementById("name").value,
    class_name: document.getElementById("class_name").value,
    lesson_date: document.getElementById("lesson_date").value,
    topic: document.getElementById("topic").value,
    line1: document.getElementById("line1").value,
    line2: document.getElementById("line2").value,
    line3: document.getElementById("line3").value
  };

  const out = document.getElementById("result");
  out.textContent = "é€ä¿¡ä¸­â€¦";

  try {
    const res = await api("/api/posts", {
      method: "POST",
      body: JSON.stringify(body)
    });

    out.textContent = JSON.stringify(res, null, 2);
    await refreshPosts();
  } catch (e) {
    out.textContent = String(e?.message || e);
  }
});

/* ===============================
   æ•™å“¡ãƒ¢ãƒ¼ãƒ‰ï¼šlocalStorage
================================ */
function loadTeacherFromStorage(){
  try{
    const raw = localStorage.getItem("three_lines_teacher");
    if (!raw) return;
    const obj = JSON.parse(raw);
    document.getElementById("teacherMode").checked = !!obj.enabled;
    document.getElementById("teacherName").value = obj.name || "";
    document.getElementById("teacherKey").value = obj.key || "";
  }catch{}
  applyTeacherStateToUI();
}
function saveTeacherToStorage(){
  const st = getTeacherState();
  localStorage.setItem("three_lines_teacher", JSON.stringify(st));
  applyTeacherStateToUI();
}

document.getElementById("btnSaveTeacher").addEventListener("click", () => {
  const st = getTeacherState();
  if (st.enabled && (!st.name || !st.key)) {
    showTeacherMsg("æ•™å“¡ãƒ¢ãƒ¼ãƒ‰ONã«ã¯ã€Œæ•™å“¡åã€ã¨ã€Œæ•™å“¡ã‚­ãƒ¼ã€ãŒå¿…è¦ã§ã™ã€‚", "warn");
    return;
  }
  saveTeacherToStorage();
  showTeacherMsg("ä¿å­˜ã—ã¾ã—ãŸã€‚", "ok");
});

document.getElementById("btnClearTeacher").addEventListener("click", () => {
  localStorage.removeItem("three_lines_teacher");
  document.getElementById("teacherMode").checked = false;
  document.getElementById("teacherName").value = "";
  document.getElementById("teacherKey").value = "";
  applyTeacherStateToUI();
  showTeacherMsg("ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚", "ok");
});

document.getElementById("teacherMode").addEventListener("change", () => {
  applyTeacherStateToUI();
  saveTeacherToStorage();
});
document.getElementById("teacherName").addEventListener("input", () => saveTeacherToStorage());
document.getElementById("teacherKey").addEventListener("input", () => saveTeacherToStorage());

/* ===============================
   åˆæœŸåŒ–
================================ */
document.getElementById("lesson_date").value =
  new Date().toISOString().slice(0,10);

loadTeacherFromStorage();
refreshPosts();
</script>

</body>
</html>
