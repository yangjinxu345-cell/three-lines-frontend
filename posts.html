<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3è¡ŒæŠ•ç¨¿</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;margin:0;background:#f5f7fb}
    header{background:#0b5ed7;color:#fff;padding:24px 16px}
    .wrap{max-width:1100px;margin:0 auto}
    a{color:#fff;text-decoration:none;font-weight:700}
    main{padding:18px 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:#fff;border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    label{display:block;font-size:12px;color:#666;margin:10px 0 6px}
    input,textarea,select{width:100%;padding:10px 12px;border:1px solid #e6e9f2;border-radius:12px;font-size:14px}
    textarea{min-height:80px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .btn{border:0;border-radius:12px;padding:10px 14px;background:#0b5ed7;color:#fff;font-weight:800;cursor:pointer}
    .btn.gray{background:#495057}
    .dot{width:10px;height:10px;border-radius:999px;background:#aaa;display:inline-block}
    .dot.ok{background:#2fb344}.dot.ng{background:#fa5252}.dot.wait{background:#fab005}
    .muted{color:#666}
    .item{border:1px solid #eef1f7;border-radius:14px;padding:12px;margin-top:10px}
    .meta{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
    .pill{background:#f1f3f7;border-radius:999px;padding:6px 10px;font-size:12px;color:#333}
    pre{background:#0b1020;color:#dfe7ff;padding:10px;border-radius:12px;overflow:auto}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div>
        <div style="opacity:.95"><a href="/index.html">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼</a></div>
        <h1 style="margin:6px 0 0">3è¡ŒæŠ•ç¨¿</h1>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <span id="dot" class="dot wait"></span>
        <span id="status" style="opacity:.95">API checking...</span>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="grid">
        <div class="card">
          <h2 style="margin:0 0 8px">æŠ•ç¨¿</h2>
          <div class="muted">3è¡Œã§ä»Šæ—¥ã®ãƒã‚¤ãƒ³ãƒˆã‚’è¨˜éŒ²</div>

          <label>åå‰</label>
          <input id="name" placeholder="ä¾‹ï¼‰æ¥Šæ—»" value="æ¥Šæ—»" />

          <label>æˆæ¥­æ—¥ï¼ˆYYYY-MM-DDï¼‰</label>
          <input id="lesson_date" placeholder="2025-12-28" />

          <label>æˆæ¥­å / ãƒ†ãƒ¼ãƒ</label>
          <input id="topic" placeholder="ä¾‹ï¼‰SQL å¤–éƒ¨çµåˆ" />

          <label>ã‚¯ãƒ©ã‚¹ï¼ˆä»»æ„ï¼‰</label>
          <input id="class_name" placeholder="ä¾‹ï¼‰ITE2" />

          <label>1è¡Œç›®</label>
          <textarea id="line1" placeholder="80æ–‡å­—ã¾ã§ï¼ˆç›®å®‰ï¼‰"></textarea>

          <label>2è¡Œç›®</label>
          <textarea id="line2" placeholder="80æ–‡å­—ã¾ã§ï¼ˆç›®å®‰ï¼‰"></textarea>

          <label>3è¡Œç›®</label>
          <textarea id="line3" placeholder="80æ–‡å­—ã¾ã§ï¼ˆç›®å®‰ï¼‰"></textarea>

          <div class="row" style="margin-top:12px">
            <button class="btn gray" id="btnFill">ã‚µãƒ³ãƒ—ãƒ«</button>
            <button class="btn" id="btnPost">é€ä¿¡</button>
          </div>

          <pre id="out" style="margin-top:12px">{}</pre>
        </div>

        <div class="card">
          <div class="row">
            <h2 style="margin:0">ã¿ã‚“ãªã®æŠ•ç¨¿ï¼ˆD1ï¼‰</h2>
            <button class="btn" id="btnRefresh">æ›´æ–°</button>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="muted">ä¿å­˜å…ˆï¼šD1ï¼ˆPages Functionsï¼‰</div>
            <div class="muted"><span id="count">0</span>ä»¶</div>
          </div>
          <div id="list"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    function todayISO(){
      const d=new Date();
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,"0");
      const dd=String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    }
    document.getElementById("lesson_date").value = todayISO();

    async function api(path, opt={}){
      const res = await fetch(path, opt);
      const text = await res.text();
      let data; try{ data = JSON.parse(text);}catch{ data = text;}
      if(!res.ok) throw new Error("HTTP "+res.status+" "+text);
      return data;
    }
    async function health(){
      const dot=document.getElementById("dot");
      const status=document.getElementById("status");
      dot.className="dot wait"; status.textContent="API checking...";
      try{ await api("/api/health"); dot.className="dot ok"; status.textContent="API: OK"; }
      catch(e){ dot.className="dot ng"; status.textContent="API: NG"; }
    }

    function renderItem(p){
      const el=document.createElement("div");
      el.className="item";
      const meta=document.createElement("div");
      meta.className="meta";
      meta.innerHTML = `
        <span class="pill">ğŸ‘¤ ${escapeHtml(p.name ?? "")}</span>
        <span class="pill">ğŸ« ${escapeHtml(p.class_name ?? "")}</span>
        <span class="pill">ğŸ§© ${escapeHtml(p.topic ?? "")}</span>
        <span class="pill">ğŸ—“ ${escapeHtml(p.lesson_date ?? "")}</span>
        <span class="pill">#${escapeHtml(String(p.id ?? ""))}</span>
      `;
      const body=document.createElement("div");
      body.innerHTML = `
        <div>1. ${escapeHtml(p.line1 ?? "")}</div>
        <div>2. ${escapeHtml(p.line2 ?? "")}</div>
        <div>3. ${escapeHtml(p.line3 ?? "")}</div>
      `;
      el.appendChild(meta);
      el.appendChild(body);
      return el;
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    async function refresh(){
      const data = await api("/api/posts?limit=50");
      const list=document.getElementById("list");
      list.innerHTML="";
      const items = data.items || [];
      document.getElementById("count").textContent = items.length;
      items.forEach(p => emphasizeExistingFields(p), list.appendChild(renderItem(p)));
    }
    function emphasizeExistingFields(p){
      // ç©ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã‚‚å£Šã‚Œãªã„ã‚ˆã†ã«ï¼ˆDBå´ã®ã‚«ãƒ©ãƒ å·®ç•°ã«è€æ€§ï¼‰
      p.name = p.name ?? "";
      p.class_name = p.class_name ?? "";
      p.topic = p.topic ?? "";
      p.lesson_date = p.lesson_date ?? "";
      p.line1 = p.line1 ?? "";
      p.line2 = p.line2 ?? "";
      p.line3 = p.line3 ?? "";
    }

    document.getElementById("btnRefresh").addEventListener("click", refresh);
    document.getElementById("btnFill").addEventListener("click", ()=>{
      document.getElementById("topic").value = "SQL å¤–éƒ¨çµåˆ";
      document.getElementById("class_name").value = "ITE2";
      document.getElementById("line1").value = "LEFT JOIN ã¯å·¦è¡¨ã‚’åŸºæº–ã«ã™ã‚‹";
      document.getElementById("line2").value = "ON æ¡ä»¶ã§çµåˆæ¡ä»¶ã‚’æŒ‡å®šã™ã‚‹";
      document.getElementById("line3").value = "WHERE æ¡ä»¶ã¯çµæœè¡Œæ•°ã«å½±éŸ¿ã™ã‚‹";
    });

    document.getElementById("btnPost").addEventListener("click", async ()=>{
      const payload = {
        name: document.getElementById("name").value.trim(),
        class_name: document.getElementById("class_name").value.trim(),
        lesson_date: document.getElementById("lesson_date").value.trim(),
        topic: document.getElementById("topic").value.trim(),
        line1: document.getElementById("line1").value.trim(),
        line2: document.getElementById("line2").value.trim(),
        line3: document.getElementById("line3").value.trim(),
      };
      const out=document.getElementById("out");
      out.textContent="sending...";
      try{
        const data = await api("/api/posts",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        out.textContent = JSON.stringify(data,null,2);
        await refresh();
      }catch(e){
        out.textContent = String(e);
      }
    });

    (async ()=>{ await health(); await refresh(); })();
  </script>
</body>
</html>
