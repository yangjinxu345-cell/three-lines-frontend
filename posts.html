<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3è¡ŒæŠ•ç¨¿ï¼ˆä¸€è¦§ï¼‰</title>
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --pri:#2563eb; --pri2:#1d4ed8; --chip:#eef2ff;
      --shadow:0 10px 30px rgba(2,6,23,.08);
      --r:18px;
    }
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;color:var(--text)}
    header{background:linear-gradient(135deg,var(--pri),var(--pri2));color:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    a{color:#fff;text-decoration:none;font-weight:800}
    h1{margin:8px 0 0;font-size:26px}
    main .wrap{padding-top:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:16px;margin-bottom:14px}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .btn{border:0;border-radius:14px;padding:10px 14px;font-weight:900;cursor:pointer}
    .btn.primary{background:var(--pri);color:#fff}
    .btn.ghost{background:#eef2ff;color:#1e40af}
    .btn.gray{background:#475569;color:#fff}
    .muted{color:var(--muted);font-size:13px}
    .list{display:flex;flex-direction:column;gap:12px}
    .post{padding:14px;border-radius:16px;border:1px solid var(--border);background:#fff}
    .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:#334155;font-size:13px}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#f1f5f9;border:1px solid #e2e8f0}
    .topic{margin-top:10px;font-weight:900}
    ol{margin:10px 0 0 20px}
    li{margin:6px 0;line-height:1.55}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .count{display:inline-flex;gap:6px;align-items:center;padding:7px 10px;border-radius:999px;background:#f8fafc;border:1px solid #e2e8f0;font-weight:800;font-size:13px}
    .hr{height:1px;background:#eef2f7;margin:12px 0}
    .comments{display:none;margin-top:10px;padding:12px;border-radius:14px;background:#fbfdff;border:1px solid #e5e7eb}
    textarea{width:100%;box-sizing:border-box;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px;min-height:70px}
    textarea:focus{outline:none;border-color:#93c5fd;box-shadow:0 0 0 4px rgba(59,130,246,.15)}
    .inline{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .err{color:#b91c1c;font-size:13px}
  </style>
</head>
<body>
<header>
  <div class="wrap top">
    <div>
      <div style="opacity:.95"><a href="/index.html">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼</a></div>
      <h1>3è¡ŒæŠ•ç¨¿ï¼ˆä¸€è¦§ï¼‰</h1>
      <div class="muted" id="me">ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ï¼šèª­ã¿è¾¼ã¿ä¸­â€¦</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <button class="btn ghost" id="btnRefresh">æ›´æ–°</button>
      <button class="btn primary" id="btnNew">ï¼‹ æ–°è¦æŠ•ç¨¿</button>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="card">
      <div class="toolbar">
        <div class="muted" id="status">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      </div>
      <div class="list" id="list"></div>
    </div>
  </div>
</main>

<script>
/* ---------- helpers ---------- */
function esc(s){ return String(s??"").replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }
function fmtCount(v){ const n=Number(v); return Number.isFinite(n)?n:0; }
function normName(s){ return String(s ?? "").replace(/\s+/g,"").trim(); }

async function api(path,opt={}){
  const res=await fetch(path,opt);
  const text=await res.text();
  let data; try{data=JSON.parse(text)}catch{data=text}
  if(!res.ok) throw new Error("HTTP "+res.status+" "+text);
  if(data && typeof data==="object" && data.ok===false) throw new Error(data.error||"API error");
  return data;
}

let ME=null;

/* å…¼å®¹ display_name / displayName */
function pickDisplayName(u){
  return u?.display_name ?? u?.displayName ?? u?.name ?? u?.username ?? "";
}

function pickRole(u){
  return u?.role ?? "";
}

function canTeacher(){
  return ME && (pickRole(ME)==="teacher" || pickRole(ME)==="admin");
}

/**
 * å½’å±åˆ¤æ–­ä¼˜å…ˆçº§ï¼š
 * 1) p.user_id === ME.id
 * 2) p.username === ME.username   (å¦‚æœåç«¯åœ¨ posts list é‡Œå¸¦äº† username)
 * 3) å»ç©ºæ ¼åï¼šp.name === ME.display_name ï¼ˆå…œåº•ï¼Œé˜²æ­¢â€œæ¥Šæ—» vs æ¥Š æ—»â€ï¼‰
 */
function canEditPost(p){
  if(!ME) return false;
  if(pickRole(ME)==="admin") return true;

  if(p.user_id != null && ME.id != null){
    return String(p.user_id) === String(ME.id);
  }

  if(p.username && ME.username){
    return String(p.username) === String(ME.username);
  }

  return normName(p.name) === normName(pickDisplayName(ME));
}

/* ---------- auth me ---------- */
async function loadMe(){
  try{
    const r = await api("/api/auth/me");
    // å¸¸è§ç»“æ„ï¼š{ok:true,user:{...}}ï¼›ä¹Ÿå¯èƒ½ {ok:true,user:null}
    const u = r?.user ?? r?.item ?? r?.me ?? null;
    if(!u){
      ME = null;
      document.getElementById("me").textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ï¼‰";
      return;
    }
    ME = u;

    const dn = pickDisplayName(u);
    const role = pickRole(u);
    const un = u.username ?? "";
    document.getElementById("me").textContent =
      `ãƒ­ã‚°ã‚¤ãƒ³ï¼š${dn || un || "?"}ï¼ˆ${role || "?"}ï¼‰`;
  }catch(e){
    ME = null;
    document.getElementById("me").textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ï¼‰";
  }
}

/* ---------- render ---------- */
function renderPost(p){
  const div=document.createElement("div");
  div.className="post";
  div.dataset.id = String(p.id);

  const likeCount = fmtCount(p.like_count ?? 0);
  const commentCount = fmtCount(p.comment_count ?? 0);

  const showEdit = canEditPost(p);
  const teacher = canTeacher();

  div.innerHTML = `
    <div class="meta">
      <span class="badge">ğŸ‘¤ ${esc(p.name||"?")}</span>
      <span class="badge">ğŸ« ${esc(p.class_name||"-")}</span>
      <span class="badge">ğŸ“… ${esc(p.lesson_date||"-")}</span>
      <span class="badge">ğŸ•’ ${esc(p.created_at||"-")}</span>
    </div>

    <div class="topic">${esc(p.topic||"")}</div>

    <ol>
      ${(p.line1||"").trim()?`<li>${esc(p.line1)}</li>`:""}
      ${(p.line2||"").trim()?`<li>${esc(p.line2)}</li>`:""}
      ${(p.line3||"").trim()?`<li>${esc(p.line3)}</li>`:""}
    </ol>

    <div class="actions">
      <span class="count" title="ã„ã„ã­æ•°">ğŸ‘ <span class="likeCount">${likeCount}</span></span>
      <span class="count" title="ã‚³ãƒ¡ãƒ³ãƒˆæ•°">ğŸ’¬ <span class="commentCount">${commentCount}</span></span>

      <button class="btn ghost btnToggle">ã‚³ãƒ¡ãƒ³ãƒˆ</button>

      ${teacher ? `<button class="btn primary btnLike">ã„ã„ã­</button>` : ``}
      ${teacher ? `<button class="btn gray btnUnlike">å–æ¶ˆ</button>` : ``}

      ${showEdit ? `<button class="btn gray btnEdit">ä¿®æ­£</button>` : ``}

      <span class="muted" style="margin-left:auto">${p.last_commented_at ? ("æœ€çµ‚ã‚³ãƒ¡ãƒ³ãƒˆ: "+esc(p.last_commented_at)) : ""}</span>
    </div>

    <div class="comments">
      <div class="muted cstatus">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      <div class="clist"></div>

      ${teacher ? `
        <div class="hr"></div>
        <div class="muted">æ•™å“¡ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ </div>
        <textarea class="cbody" placeholder="å…ˆç”Ÿã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æ›¸ã„ã¦ãã ã•ã„"></textarea>
        <div class="inline">
          <button class="btn primary btnAdd">ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿</button>
        </div>
      ` : ``}

      <div class="err cerr" style="display:none"></div>
    </div>
  `;

  wire(div, p);
  return div;
}

function renderCommentItem(c){
  return `
    <div style="padding:10px 0;border-top:1px solid #eef2f7">
      <div class="muted" style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div>ğŸ‘©â€ğŸ« ${esc(c.teacher_name||"?")} ï½œ ğŸ•’ ${esc(c.created_at||"-")}${c.updated_at ? (" ï½œ âœï¸ "+esc(c.updated_at)) : ""}</div>
      </div>
      <div style="white-space:pre-wrap;line-height:1.55;margin-top:6px">${esc(c.body||"")}</div>
    </div>
  `;
}

/* ---------- actions ---------- */
function wire(div,p){
  const id = Number(p.id);

  const btnEdit = div.querySelector(".btnEdit");
  if(btnEdit){
    btnEdit.onclick = () => location.href = `/posts_modify.html?id=${encodeURIComponent(id)}`;
  }

  const box = div.querySelector(".comments");
  const btnToggle = div.querySelector(".btnToggle");
  const cstatus = div.querySelector(".cstatus");
  const clist = div.querySelector(".clist");
  const cerr = div.querySelector(".cerr");

  btnToggle.onclick = async () => {
    const shown = box.style.display !== "none";
    if(shown){ box.style.display="none"; return; }
    box.style.display="";
    cerr.style.display="none"; cerr.textContent="";
    cstatus.textContent="èª­ã¿è¾¼ã¿ä¸­â€¦";
    clist.innerHTML="";
    try{
      const data = await api(`/api/posts/${id}/comments`);
      const items = data.items || data.comments || [];
      cstatus.textContent = items.length ? `ã‚³ãƒ¡ãƒ³ãƒˆï¼š${items.length}ä»¶` : "ã‚³ãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚";
      clist.innerHTML = items.map(renderCommentItem).join("");
    }catch(e){
      cstatus.textContent="ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼";
      cerr.style.display=""; cerr.textContent=String(e.message||e);
    }
  };

  const likeCountEl = div.querySelector(".likeCount");

  const btnLike = div.querySelector(".btnLike");
  if(btnLike){
    btnLike.onclick = async () => {
      try{
        const r = await api(`/api/posts/${id}/like`, { method:"POST" });
        likeCountEl.textContent = String(r.like_count ?? r.likeCount ?? likeCountEl.textContent);
      }catch(e){
        alert(String(e.message||e));
      }
    };
  }

  const btnUnlike = div.querySelector(".btnUnlike");
  if(btnUnlike){
    btnUnlike.onclick = async () => {
      try{
        const r = await api(`/api/posts/${id}/like`, { method:"DELETE" });
        likeCountEl.textContent = String(r.like_count ?? r.likeCount ?? likeCountEl.textContent);
      }catch(e){
        alert(String(e.message||e));
      }
    };
  }

  const btnAdd = div.querySelector(".btnAdd");
  if(btnAdd){
    btnAdd.onclick = async () => {
      const ta = div.querySelector(".cbody");
      const body = (ta.value||"").trim();
      if(!body){ alert("ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ãŒç©ºã§ã™"); return; }
      try{
        await api(`/api/posts/${id}/comments`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ body })
        });
        ta.value="";
        // reload comments quickly
        btnToggle.click();
        btnToggle.click();
      }catch(e){
        alert(String(e.message||e));
      }
    };
  }
}

/* ---------- load list ---------- */
async function refresh(){
  document.getElementById("status").textContent="èª­ã¿è¾¼ã¿ä¸­â€¦";
  const list=document.getElementById("list");
  list.innerHTML="";
  try{
    const data = await api("/api/posts?limit=50");
    const items = data.items || [];
    document.getElementById("status").textContent = `ä»¶æ•°ï¼š${items.length}`;
    items.forEach(p=>list.appendChild(renderPost(p)));
  }catch(e){
    document.getElementById("status").textContent="ã‚¨ãƒ©ãƒ¼: "+String(e.message||e);
  }
}

document.getElementById("btnRefresh").onclick = refresh;
document.getElementById("btnNew").onclick = () => location.href = "/posts_new.html";

(async () => {
  await loadMe();
  await refresh();
})();
</script>
</body>
</html>
