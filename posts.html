<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3Ë°åÊäïÁ®øÔºà‰∏ÄË¶ßÔºâ</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --pri:#2563eb;
      --pri2:#1d4ed8;
      --shadow:0 10px 30px rgba(2,6,23,.08);
      --r:18px;
      --row:#ffffff;
      --rowHover:#f8fafc;
      --rowActive:#eef6ff;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      color:var(--text);
    }

    header{
      background:linear-gradient(135deg,var(--pri),var(--pri2));
      color:#fff;
    }
    .wrap{max-width:1160px;margin:0 auto;padding:18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    a{color:#fff;text-decoration:none;font-weight:800}
    h1{margin:8px 0 0;font-size:26px}
    .muted{color:var(--muted);font-size:13px}

    main .wrap{padding-top:14px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:14px
    }
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .btn{border:0;border-radius:14px;padding:10px 14px;font-weight:900;cursor:pointer}
    .btn.primary{background:var(--pri);color:#fff}
    .btn.ghost{background:#eef2ff;color:#1e40af}
    .btn.gray{background:#475569;color:#fff}

    .hr{height:1px;background:#eef2f7;margin:12px 0}

    /* ===== Filter ===== */
    .filterWrap{margin-top:10px}
    .filterTitle{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .filterGrid{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1.2fr;
      gap:10px;
    }
    .filterCell{
      background:#fbfdff;
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:10px;
    }
    .filterLabel{
      font-size:12px;
      color:#334155;
      font-weight:900;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      background:#fff;
      font-size:14px;
      outline:none;
    }
    select:focus{
      border-color:#93c5fd;
      box-shadow:0 0 0 4px rgba(59,130,246,.15);
    }
    .smallBtn{border:0;border-radius:12px;padding:8px 12px;font-weight:900;cursor:pointer}
    .smallBtn.clear{background:#eef2ff;color:#1e40af}
    @media (max-width: 900px){ .filterGrid{grid-template-columns:1fr 1fr} }
    @media (max-width: 520px){ .filterGrid{grid-template-columns:1fr} }

    /* ===== Table ===== */
    .tableWrap{
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
    }
    .thead, .trow{
      display:grid;
      grid-template-columns: 160px 140px 120px 1.3fr 180px;
      align-items:center;
    }
    .thead{
      background:#f8fafc;
      border-bottom:1px solid var(--border);
      font-size:12px;
      color:#334155;
      font-weight:900;
      letter-spacing:.02em;
    }
    .th, .td{padding:10px 12px}
    .th{white-space:nowrap}
    .trow{
      background:var(--row);
      border-bottom:1px solid #f1f5f9;
      cursor:pointer;
    }
    .trow:hover{background:var(--rowHover)}
    .trow.active{background:var(--rowActive)}
    .td{
      font-size:13px;
      color:#0f172a;
      min-width:0;
    }
    .cellMuted{color:var(--muted);font-size:12px}
    .ellipsis{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .topicStrong{font-weight:900}
    .preview{
      display:block;
      margin-top:2px;
      color:var(--muted);
      font-size:12px;
    }
    .actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
    }

    @media (max-width: 980px){
      .thead, .trow{
        grid-template-columns: 150px 120px 110px 1fr 160px;
      }
    }
    @media (max-width: 760px){
      .thead{display:none;}
      .trow{
        grid-template-columns: 1fr 160px;
        grid-template-areas:
          "main actions";
      }
      .td{padding:10px 12px}
      .td.colName, .td.colClass, .td.colDate{display:none;}
      .td.colTopic{grid-area:main}
      .td.colActions{grid-area:actions}
    }

    /* ===== Icon buttons (YouTube-ish) ===== */
    .iconBtn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid #e2e8f0;
      background:#fff;
      cursor:pointer;
      font-weight:900;
      color:#0f172a;
      user-select:none;
    }
    .iconBtn:hover{background:#f8fafc}
    .iconBtn svg{width:18px;height:18px}
    .iconBtn .num{font-size:12px;color:#0f172a;min-width:10px}
    .iconBtn.on{background:#e0ecff;border-color:#b6d2ff;color:#1e40af}
    .iconBtn.on .num{color:#1e40af}
    .iconBtn:disabled{opacity:.6;cursor:not-allowed}

    .miniBtn{
      border:1px solid #e2e8f0;
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
    }
    .miniBtn:hover{background:#f8fafc}

    /* ===== Detail panel (B) ===== */
    .detailWrap{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      box-shadow:0 8px 24px rgba(2,6,23,.06);
      overflow:hidden;
      display:none;
    }
    .detailHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px 10px;
      border-bottom:1px solid #f1f5f9;
      background:#fbfdff;
    }
    .detailTitle{
      font-weight:900;
      font-size:16px;
      margin:0;
    }
    .detailMeta{
      margin-top:4px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      font-size:12px;
      color:var(--muted);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #e2e8f0;
      background:#fff;
      color:#334155;
      font-weight:900;
    }
    .detailBody{padding:12px 14px 14px}
    .lines{
      margin:0;
      padding-left:18px;
      line-height:1.6;
    }
    .lines li{margin:6px 0}
    .detailGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:10px;
    }
    .commentBox{
      margin-top:10px;
      padding:12px;
      border:1px solid #e5e7eb;
      border-radius:14px;
      background:#fbfdff;
    }
    .commentList .item{
      padding:10px 0;
      border-top:1px solid #eef2f7;
    }
    textarea{
      width:100%;
      box-sizing:border-box;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      min-height:70px;
    }
    textarea:focus{outline:none;border-color:#93c5fd;box-shadow:0 0 0 4px rgba(59,130,246,.15)}
    .inline{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .err{color:#b91c1c;font-size:13px}
  </style>
</head>

<body>
<header>
  <div class="wrap top">
    <div>
      <div style="opacity:.95"><a href="/index.html">‚Üê „É°„Éã„É•„Éº</a></div>
      <h1>3Ë°åÊäïÁ®øÔºà‰∏ÄË¶ßÔºâ</h1>
      <div class="muted" id="me" style="color:rgba(255,255,255,.88)">„É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±ÔºöË™≠„ÅøËæº„Åø‰∏≠‚Ä¶</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <button class="btn ghost" id="btnRefresh">Êõ¥Êñ∞</button>
      <button class="btn primary" id="btnNew">Ôºã Êñ∞Ë¶èÊäïÁ®ø</button>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="card">
      <!-- Filter UI -->
      <div class="filterWrap">
        <div class="filterTitle">
          <div class="muted" style="font-weight:900">„Éï„Ç£„É´„Çø„Éº</div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <div class="muted" id="filterStatus">Ë°®Á§∫Ôºö0 / 0</div>
            <button class="smallBtn clear" id="btnClear">„ÇØ„É™„Ç¢</button>
          </div>
        </div>

        <div class="filterGrid">
          <div class="filterCell">
            <div class="filterLabel">üë§ ÂêçÂâç</div>
            <select id="fName"><option value="">„Åô„Åπ„Å¶</option></select>
          </div>
          <div class="filterCell">
            <div class="filterLabel">üè´ „ÇØ„É©„Çπ</div>
            <select id="fClass"><option value="">„Åô„Åπ„Å¶</option></select>
          </div>
          <div class="filterCell">
            <div class="filterLabel">üìÖ ÊéàÊ•≠Êó•</div>
            <select id="fDate"><option value="">„Åô„Åπ„Å¶</option></select>
          </div>
          <div class="filterCell">
            <div class="filterLabel">üìò ÊéàÊ•≠Âêç / „ÉÜ„Éº„Éû</div>
            <select id="fTopic"><option value="">„Åô„Åπ„Å¶</option></select>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="toolbar">
        <div class="muted" id="status">Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶</div>
      </div>

      <!-- Table -->
      <div class="tableWrap">
        <div class="thead">
          <div class="th">ÂêçÂâç</div>
          <div class="th">„ÇØ„É©„Çπ</div>
          <div class="th">ÊéàÊ•≠Êó•</div>
          <div class="th">ÊéàÊ•≠Âêç / „ÉÜ„Éº„ÉûÔºà„Éó„É¨„Éì„É•„ÉºÔºâ</div>
          <div class="th" style="text-align:right">Êìç‰Ωú</div>
        </div>
        <div id="tbody"></div>
      </div>

      <!-- Detail panel (single, reused) -->
      <div id="detail" class="detailWrap"></div>
    </div>
  </div>
</main>

<script>
/* ---------- helpers ---------- */
function esc(s){ return String(s??"").replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }
function fmtCount(v){ const n=Number(v); return Number.isFinite(n)?n:0; }
function normName(s){ return String(s ?? "").replace(/\s+/g,"").trim(); }
function previewText(p){
  const a = (p.line1||"").trim();
  const b = (p.line2||"").trim();
  const c = (p.line3||"").trim();
  const first = a || b || c || "";
  return first.length > 60 ? first.slice(0,60) + "‚Ä¶" : first;
}

async function api(path,opt={}){
  const res=await fetch(path,{ credentials:"include", cache:"no-store", ...opt });
  const text=await res.text();
  let data; try{data=JSON.parse(text)}catch{data=text}
  if(!res.ok) throw new Error("HTTP "+res.status+" "+text);
  if(data && typeof data==="object" && data.ok===false) throw new Error(data.error||"API error");
  return data;
}

let ME=null;
let ALL_ITEMS=[];
let VIEW_ITEMS=[];
let ACTIVE_ID=null;

/* user helpers */
function pickDisplayName(u){ return u?.display_name ?? u?.displayName ?? u?.name ?? u?.username ?? ""; }
function pickRole(u){ return u?.role ?? ""; }

function canEditPost(p){
  if(!ME) return false;
  if(pickRole(ME)==="admin") return true;
  if(p.user_id != null && ME.id != null) return String(p.user_id) === String(ME.id);
  if(p.username && ME.username) return String(p.username) === String(ME.username);
  return normName(p.name) === normName(pickDisplayName(ME));
}

/* ---------- icons ---------- */
function likeSvg(filled){
  if(filled){
    return `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path fill="currentColor" d="M2 21h4V9H2v12zm20-11c0-1.1-.9-2-2-2h-6.3l1-4.6.03-.32c0-.41-.17-.79-.44-1.06L13 1 7.6 6.4C7.22 6.78 7 7.3 7 7.83V19c0 1.1.9 2 2 2h8c.82 0 1.54-.5 1.84-1.22l2.02-4.71c.09-.23.14-.47.14-.72V10z"/>
    </svg>`;
  }
  return `<svg viewBox="0 0 24 24" aria-hidden="true">
    <path fill="currentColor" d="M2 21h4V9H2v12zM22 10c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L13 1 7.59 6.41C7.22 6.78 7 7.3 7 7.83V19c0 1.1.9 2 2 2h8c.82 0 1.54-.5 1.84-1.22l2.02-4.71c.09-.23.14-.47.14-.72V10zm-2 4.06L17.98 19H9V7.83l3.34-3.34L11.12 10H20v4.06z"/>
  </svg>`;
}
function chatSvg(){
  return `<svg viewBox="0 0 24 24" aria-hidden="true">
    <path fill="currentColor" d="M4 4h16v12H7.17L4 19.17V4zm3 5h10v2H7V9zm0-3h10v2H7V6zm0 6h7v2H7v-2z"/>
  </svg>`;
}
function editSvg(){
  return `<svg viewBox="0 0 24 24" aria-hidden="true">
    <path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zm2.92 2.83H5v-.92l9.06-9.06.92.92L5.92 20.08zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
  </svg>`;
}
function setLiked(btn, liked){
  btn.dataset.liked = liked ? "1" : "0";
  btn.classList.toggle("on", liked);
  const ico = btn.querySelector(".ico");
  if(ico) ico.innerHTML = likeSvg(liked);
}

/* ---------- auth me ---------- */
async function loadMe(){
  try{
    const r = await api("/api/auth/me?ts="+Date.now());
    const u = r?.user ?? r?.item ?? r?.me ?? null;
    if(!u){
      ME=null;
      document.getElementById("me").textContent="Êú™„É≠„Ç∞„Ç§„É≥Ôºà„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ";
      return;
    }
    ME=u;
    const dn=pickDisplayName(u);
    const role=pickRole(u);
    const un=u.username ?? "";
    document.getElementById("me").textContent = `„É≠„Ç∞„Ç§„É≥Ôºö${dn || un || "?"}Ôºà${role || "?"}Ôºâ`;
  }catch(_e){
    ME=null;
    document.getElementById("me").textContent="Êú™„É≠„Ç∞„Ç§„É≥Ôºà„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ";
  }
}

/* ---------- table render ---------- */
function renderRow(p){
  const row=document.createElement("div");
  row.className="trow";
  row.dataset.id=String(p.id);

  const likeCount = fmtCount(p.like_count ?? 0);
  const commentCount = fmtCount(p.comment_count ?? 0);
  const canEdit = canEditPost(p);

  row.innerHTML = `
    <div class="td colName">
      <div class="ellipsis" title="${esc(p.name||"")}">${esc(p.name||"-")}</div>
      <div class="cellMuted ellipsis">${esc(p.created_at||"")}</div>
    </div>

    <div class="td colClass">
      <div class="ellipsis" title="${esc(p.class_name||"")}">${esc(p.class_name||"-")}</div>
    </div>

    <div class="td colDate">
      <div class="ellipsis">${esc(p.lesson_date||"-")}</div>
    </div>

    <div class="td colTopic">
      <div class="topicStrong ellipsis" title="${esc(p.topic||"")}">${esc(p.topic||"-")}</div>
      <span class="preview ellipsis" title="${esc(previewText(p))}">${esc(previewText(p))}</span>
    </div>

    <div class="td colActions">
      <div class="actions">
        <button class="iconBtn btnLikeToggle" data-liked="0" title="„ÅÑ„ÅÑ„Å≠">
          <span class="ico">${likeSvg(false)}</span>
          <span class="num likeCount">${likeCount}</span>
        </button>

        <button class="iconBtn btnComment" title="„Ç≥„É°„É≥„Éà">
          <span class="ico">${chatSvg()}</span>
          <span class="num commentCount">${commentCount}</span>
        </button>

        ${canEdit ? `
          <button class="iconBtn btnEdit" title="‰øÆÊ≠£">
            <span class="ico">${editSvg()}</span>
          </button>
        ` : ``}
      </div>
    </div>
  `;

  wireRow(row, p);
  return row;
}

function renderTable(items){
  const tbody=document.getElementById("tbody");
  tbody.innerHTML="";
  items.forEach(p=>tbody.appendChild(renderRow(p)));
}

/* ---------- detail panel ---------- */
function renderCommentItem(c){
  const who = c.user_name ?? c.teacher_name ?? c.author ?? "?";
  return `
    <div class="item">
      <div class="muted" style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div>üßë ${esc(who)} ÔΩú üïí ${esc(c.created_at||"-")}${c.updated_at ? (" ÔΩú ‚úèÔ∏è "+esc(c.updated_at)) : ""}</div>
      </div>
      <div style="white-space:pre-wrap;line-height:1.55;margin-top:6px">${esc(c.body||"")}</div>
    </div>
  `;
}

async function openDetail(p, focusComment=false){
  const detail=document.getElementById("detail");
  detail.style.display="block";

  detail.innerHTML = `
    <div class="detailHead">
      <div>
        <div class="detailTitle">${esc(p.topic || "(ÁÑ°È°å)")}</div>
        <div class="detailMeta">
          <span class="pill">üë§ ${esc(p.name||"-")}</span>
          <span class="pill">üè´ ${esc(p.class_name||"-")}</span>
          <span class="pill">üìÖ ${esc(p.lesson_date||"-")}</span>
          <span class="pill">üïí ${esc(p.created_at||"-")}</span>
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
        <button class="miniBtn" id="btnClose">Èñâ„Åò„Çã</button>
      </div>
    </div>

    <div class="detailBody">
      <ol class="lines">
        ${(p.line1||"").trim()?`<li>${esc(p.line1)}</li>`:""}
        ${(p.line2||"").trim()?`<li>${esc(p.line2)}</li>`:""}
        ${(p.line3||"").trim()?`<li>${esc(p.line3)}</li>`:""}
      </ol>

      <div class="commentBox" id="commentBox">
        <div class="muted" style="font-weight:900">„Ç≥„É°„É≥„Éà</div>
        <div class="muted" id="cstatus" style="margin-top:6px">Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶</div>
        <div class="commentList" id="clist"></div>

        <div class="hr"></div>
        <div class="muted">„Ç≥„É°„É≥„Éà„ÇíËøΩÂä†</div>
        <textarea id="cbody" placeholder="„Ç≥„É°„É≥„Éà„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
        <div class="inline">
          <button class="btn primary" id="btnAdd">„Ç≥„É°„É≥„ÉàÊäïÁ®ø</button>
        </div>

        <div class="err" id="cerr" style="display:none"></div>
      </div>
    </div>
  `;

  document.getElementById("btnClose").onclick = ()=>{
    ACTIVE_ID=null;
    // Ë°å„ÅÆactiveËß£Èô§
    document.querySelectorAll(".trow.active").forEach(n=>n.classList.remove("active"));
    detail.style.display="none";
    detail.innerHTML="";
  };

  // load comments
  const cstatus = document.getElementById("cstatus");
  const clist = document.getElementById("clist");
  const cerr = document.getElementById("cerr");

  cerr.style.display="none"; cerr.textContent="";
  clist.innerHTML="";
  cstatus.textContent="Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶";

  try{
    const data = await api(`/api/posts/${encodeURIComponent(p.id)}/comments?ts=${Date.now()}`);
    const items = data.items || data.comments || [];
    cstatus.textContent = items.length ? `„Ç≥„É°„É≥„ÉàÔºö${items.length}‰ª∂` : "„Ç≥„É°„É≥„Éà„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ";
    clist.innerHTML = items.map(renderCommentItem).join("");
  }catch(e){
    cstatus.textContent="„Ç≥„É°„É≥„ÉàÂèñÂæó„Ç®„É©„Éº";
    cerr.style.display=""; cerr.textContent=String(e.message||e);
  }

  document.getElementById("btnAdd").onclick = async ()=>{
    if(!ME){
      alert("„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
      location.replace("/login?ts="+Date.now());
      return;
    }
    const body = (document.getElementById("cbody").value || "").trim();
    if(!body){ alert("„Ç≥„É°„É≥„ÉàÊú¨Êñá„ÅåÁ©∫„Åß„Åô"); return; }

    try{
      await api(`/api/posts/${encodeURIComponent(p.id)}/comments`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ body })
      });
      document.getElementById("cbody").value="";

      // refresh comments
      const data = await api(`/api/posts/${encodeURIComponent(p.id)}/comments?ts=${Date.now()}`);
      const items = data.items || data.comments || [];
      cstatus.textContent = items.length ? `„Ç≥„É°„É≥„ÉàÔºö${items.length}‰ª∂` : "„Ç≥„É°„É≥„Éà„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ";
      clist.innerHTML = items.map(renderCommentItem).join("");

      // update table count optimistically
      const row = document.querySelector(`.trow[data-id="${CSS.escape(String(p.id))}"]`);
      if(row){
        const cc = row.querySelector(".commentCount");
        if(cc) cc.textContent = String(Number(cc.textContent||0)+1);
      }
    }catch(e){
      cerr.style.display=""; cerr.textContent=String(e.message||e);
    }
  };

  if(focusComment){
    const box = document.getElementById("commentBox");
    box.scrollIntoView({ behavior:"smooth", block:"start" });
    setTimeout(()=>document.getElementById("cbody")?.focus(), 250);
  }
}

/* ---------- wiring row ---------- */
function wireRow(row, p){
  // click row: open detail
  row.addEventListener("click", (ev)=>{
    // Â¶ÇÊûúÁÇπÁöÑÊòØÊåâÈíÆÔºå‰∏çËÆ©Ë°åÁÇπÂáªÈáçÂ§çËß¶Âèë
    if(ev.target.closest("button")) return;
    toggleActive(row, p, false);
  });

  // like
  const btnLike = row.querySelector(".btnLikeToggle");
  const likeCountEl = row.querySelector(".likeCount");
  btnLike.onclick = async (ev)=>{
    ev.stopPropagation();
    if(!ME){
      alert("„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
      location.replace("/login?ts="+Date.now());
      return;
    }
    btnLike.disabled = true;
    try{
      const likedNow = btnLike.dataset.liked === "1";
      if(!likedNow){
        const r = await api(`/api/posts/${encodeURIComponent(p.id)}/like`, { method:"POST" });
        likeCountEl.textContent = String(r.like_count ?? r.likeCount ?? likeCountEl.textContent);
        setLiked(btnLike, true);
      }else{
        const r = await api(`/api/posts/${encodeURIComponent(p.id)}/like`, { method:"DELETE" });
        likeCountEl.textContent = String(r.like_count ?? r.likeCount ?? likeCountEl.textContent);
        setLiked(btnLike, false);
      }
    }catch(e){
      alert(String(e.message||e));
    }finally{
      btnLike.disabled = false;
    }
  };

  // comment button: open detail & focus comment
  const btnComment = row.querySelector(".btnComment");
  btnComment.onclick = async (ev)=>{
    ev.stopPropagation();
    toggleActive(row, p, true);
  };

  // edit
  const btnEdit = row.querySelector(".btnEdit");
  if(btnEdit){
    btnEdit.onclick = (ev)=>{
      ev.stopPropagation();
      location.href = `/posts_modify.html?id=${encodeURIComponent(p.id)}`;
    };
  }
}

function toggleActive(row, p, focusComment){
  const id = String(p.id);

  // click same row: collapse
  if(ACTIVE_ID === id){
    ACTIVE_ID = null;
    row.classList.remove("active");
    const detail=document.getElementById("detail");
    detail.style.display="none";
    detail.innerHTML="";
    return;
  }

  ACTIVE_ID = id;
  document.querySelectorAll(".trow.active").forEach(n=>n.classList.remove("active"));
  row.classList.add("active");

  openDetail(p, focusComment);
}

/* ---------- like status loader ---------- */
async function loadLikeStatusForVisible(){
  const nodes = Array.from(document.querySelectorAll(".trow"));
  const tasks = nodes.map(n=> async ()=>{
    const id = n.dataset.id;
    const btn = n.querySelector(".btnLikeToggle");
    const countEl = n.querySelector(".likeCount");
    if(!btn) return;

    try{
      const r = await api(`/api/posts/${encodeURIComponent(id)}/like?ts=`+Date.now());
      setLiked(btn, !!r.liked);
      countEl.textContent = String(r.like_count ?? r.likeCount ?? countEl.textContent);
    }catch(_e){}
  });

  const limit = 8;
  let idx = 0;
  async function worker(){ while(idx < tasks.length){ await tasks[idx++](); } }
  await Promise.all(Array.from({length:Math.min(limit,tasks.length)}, worker));
}

/* ---------- filter ---------- */
const $fName  = document.getElementById("fName");
const $fClass = document.getElementById("fClass");
const $fDate  = document.getElementById("fDate");
const $fTopic = document.getElementById("fTopic");
const $filterStatus = document.getElementById("filterStatus");

function uniqSorted(arr){
  const s = new Set();
  for(const v of arr){
    const t = String(v ?? "").trim();
    if(t) s.add(t);
  }
  return Array.from(s).sort((a,b)=>a.localeCompare(b,"ja"));
}

function rebuildFilterOptions(items){
  const keep = { name:$fName.value, cls:$fClass.value, date:$fDate.value, topic:$fTopic.value };
  const names  = uniqSorted(items.map(x=>x.name));
  const clses  = uniqSorted(items.map(x=>x.class_name));
  const dates  = uniqSorted(items.map(x=>x.lesson_date)).sort((a,b)=>String(b).localeCompare(String(a)));
  const topics = uniqSorted(items.map(x=>x.topic));

  function fill(sel, values, keepVal){
    sel.innerHTML = `<option value="">„Åô„Åπ„Å¶</option>` + values.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join("");
    if(keepVal && values.includes(keepVal)) sel.value = keepVal;
    else sel.value = "";
  }
  fill($fName, names, keep.name);
  fill($fClass, clses, keep.cls);
  fill($fDate, dates, keep.date);
  fill($fTopic, topics, keep.topic);
}

function applyFilters(){
  const vName  = $fName.value;
  const vClass = $fClass.value;
  const vDate  = $fDate.value;
  const vTopic = $fTopic.value;

  VIEW_ITEMS = ALL_ITEMS.filter(p=>{
    if(vName  && String(p.name||"").trim() !== vName) return false;
    if(vClass && String(p.class_name||"").trim() !== vClass) return false;
    if(vDate  && String(p.lesson_date||"").trim() !== vDate) return false;
    if(vTopic && String(p.topic||"").trim() !== vTopic) return false;
    return true;
  });

  renderTable(VIEW_ITEMS);
  $filterStatus.textContent = `Ë°®Á§∫Ôºö${VIEW_ITEMS.length} / ${ALL_ITEMS.length}`;

  // clear open detail if filtered out
  if(ACTIVE_ID && !VIEW_ITEMS.some(x=>String(x.id)===String(ACTIVE_ID))){
    ACTIVE_ID = null;
    const detail=document.getElementById("detail");
    detail.style.display="none";
    detail.innerHTML="";
  }

  loadLikeStatusForVisible();
}

function clearFilters(){
  $fName.value = "";
  $fClass.value = "";
  $fDate.value = "";
  $fTopic.value = "";
  applyFilters();
}

/* ---------- load list ---------- */
async function refresh(){
  document.getElementById("status").textContent="Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶";
  document.getElementById("tbody").innerHTML="";
  const detail=document.getElementById("detail");
  detail.style.display="none"; detail.innerHTML="";
  ACTIVE_ID=null;

  try{
    const data = await api("/api/posts?limit=50&ts="+Date.now());
    ALL_ITEMS = data.items || [];
    document.getElementById("status").textContent = `‰ª∂Êï∞Ôºö${ALL_ITEMS.length}`;

    rebuildFilterOptions(ALL_ITEMS);
    applyFilters();
  }catch(e){
    document.getElementById("status").textContent="„Ç®„É©„Éº: "+String(e.message||e);
  }
}

/* ---------- init ---------- */
document.getElementById("btnRefresh").onclick = refresh;
document.getElementById("btnNew").onclick = () => location.href = "/posts_new.html";
document.getElementById("btnClear").onclick = clearFilters;
[$fName,$fClass,$fDate,$fTopic].forEach(sel=> sel.addEventListener("change", applyFilters));

(async () => {
  await loadMe();
  await refresh();
})();
</script>
</body>
</html>
