<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3è¡ŒæŠ•ç¨¿ï¼ˆä¸€è¦§ï¼‰</title>
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --pri:#2563eb; --pri2:#1d4ed8; --chip:#eef2ff;
      --shadow:0 10px 30px rgba(2,6,23,.08);
      --r:18px;
    }
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;color:var(--text)}
    header{background:linear-gradient(135deg,var(--pri),var(--pri2));color:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    a{color:#fff;text-decoration:none;font-weight:800}
    h1{margin:8px 0 0;font-size:26px}
    main .wrap{padding-top:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:16px;margin-bottom:14px}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .btn{border:0;border-radius:14px;padding:10px 14px;font-weight:900;cursor:pointer}
    .btn.primary{background:var(--pri);color:#fff}
    .btn.ghost{background:#eef2ff;color:#1e40af}
    .btn.gray{background:#475569;color:#fff}
    .muted{color:var(--muted);font-size:13px}
    .list{display:flex;flex-direction:column;gap:12px}
    .post{padding:14px;border-radius:16px;border:1px solid var(--border);background:#fff}
    .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:#334155;font-size:13px}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#f1f5f9;border:1px solid #e2e8f0}
    .topic{margin-top:10px;font-weight:900}
    ol{margin:10px 0 0 20px}
    li{margin:6px 0;line-height:1.55}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .hr{height:1px;background:#eef2f7;margin:12px 0}
    .comments{display:none;margin-top:10px;padding:12px;border-radius:14px;background:#fbfdff;border:1px solid #e5e7eb}
    textarea{width:100%;box-sizing:border-box;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px;min-height:70px}
    textarea:focus{outline:none;border-color:#93c5fd;box-shadow:0 0 0 4px rgba(59,130,246,.15)}
    .inline{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .err{color:#b91c1c;font-size:13px}

    /* ===== Filter ===== */
    .filterWrap{margin-top:10px}
    .filterTitle{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .filterGrid{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1.2fr;
      gap:10px;
    }
    .filterCell{
      background:#fbfdff;
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:10px;
    }
    .filterLabel{
      font-size:12px;
      color:#334155;
      font-weight:900;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      background:#fff;
      font-size:14px;
      outline:none;
    }
    select:focus{
      border-color:#93c5fd;
      box-shadow:0 0 0 4px rgba(59,130,246,.15);
    }
    .smallBtn{
      border:0;border-radius:12px;padding:8px 12px;font-weight:900;cursor:pointer
    }
    .smallBtn.clear{background:#eef2ff;color:#1e40af}
    @media (max-width: 860px){
      .filterGrid{grid-template-columns:1fr 1fr}
    }
    @media (max-width: 520px){
      .filterGrid{grid-template-columns:1fr}
    }

    /* ===== YouTube-like like button ===== */
    .iconBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #e2e8f0;
      background:#fff;
      cursor:pointer;
      font-weight:900;
      color:#0f172a;
      user-select:none;
    }
    .iconBtn:hover{background:#f8fafc}
    .iconBtn svg{width:18px;height:18px}
    .iconBtn .num{font-size:13px;color:#0f172a;min-width:10px}
    .iconBtn.on{
      background:#e0ecff;
      border-color:#b6d2ff;
      color:#1e40af;
    }
    .iconBtn.on .num{color:#1e40af}
    .iconBtn:disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
<header>
  <div class="wrap top">
    <div>
      <div style="opacity:.95"><a href="/index.html">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼</a></div>
      <h1>3è¡ŒæŠ•ç¨¿ï¼ˆä¸€è¦§ï¼‰</h1>
      <div class="muted" id="me">ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ï¼šèª­ã¿è¾¼ã¿ä¸­â€¦</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <button class="btn ghost" id="btnRefresh">æ›´æ–°</button>
      <button class="btn primary" id="btnNew">ï¼‹ æ–°è¦æŠ•ç¨¿</button>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="card">

      <!-- Filter UI -->
      <div class="filterWrap">
        <div class="filterTitle">
          <!-- âœ… åˆ é™¤ï¼ˆExcelé¢¨ï¼‰ -->
          <div class="muted" style="font-weight:900">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <div class="muted" id="filterStatus">è¡¨ç¤ºï¼š0 / 0</div>
            <button class="smallBtn clear" id="btnClear">ã‚¯ãƒªã‚¢</button>
          </div>
        </div>

        <div class="filterGrid">
          <div class="filterCell">
            <div class="filterLabel">ğŸ‘¤ åå‰</div>
            <select id="fName"><option value="">ã™ã¹ã¦</option></select>
          </div>
          <div class="filterCell">
            <div class="filterLabel">ğŸ« ã‚¯ãƒ©ã‚¹</div>
            <select id="fClass"><option value="">ã™ã¹ã¦</option></select>
          </div>
          <div class="filterCell">
            <div class="filterLabel">ğŸ“… æˆæ¥­æ—¥</div>
            <select id="fDate"><option value="">ã™ã¹ã¦</option></select>
          </div>
          <div class="filterCell">
            <div class="filterLabel">ğŸ“˜ æˆæ¥­å / ãƒ†ãƒ¼ãƒ</div>
            <select id="fTopic"><option value="">ã™ã¹ã¦</option></select>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="toolbar">
        <div class="muted" id="status">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      </div>

      <div class="list" id="list"></div>
    </div>
  </div>
</main>

<script>
/* ---------- helpers ---------- */
function esc(s){ return String(s??"").replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }
function fmtCount(v){ const n=Number(v); return Number.isFinite(n)?n:0; }
function normName(s){ return String(s ?? "").replace(/\s+/g,"").trim(); }

async function api(path,opt={}){
  const res=await fetch(path,{
    credentials:"include",
    cache:"no-store",
    ...opt
  });
  const text=await res.text();
  let data; try{data=JSON.parse(text)}catch{data=text}
  if(!res.ok) throw new Error("HTTP "+res.status+" "+text);
  if(data && typeof data==="object" && data.ok===false) throw new Error(data.error||"API error");
  return data;
}

let ME=null;
let ALL_ITEMS=[];
let VIEW_ITEMS=[];

/* å…¼å®¹ display_name / displayName */
function pickDisplayName(u){
  return u?.display_name ?? u?.displayName ?? u?.name ?? u?.username ?? "";
}
function pickRole(u){
  return u?.role ?? "";
}

/**
 * å½’å±åˆ¤æ–­ä¼˜å…ˆçº§ï¼š
 * 1) p.user_id === ME.id
 * 2) p.username === ME.username
 * 3) å»ç©ºæ ¼åï¼šp.name === ME.display_name
 */
function canEditPost(p){
  if(!ME) return false;
  if(pickRole(ME)==="admin") return true;

  if(p.user_id != null && ME.id != null){
    return String(p.user_id) === String(ME.id);
  }
  if(p.username && ME.username){
    return String(p.username) === String(ME.username);
  }
  return normName(p.name) === normName(pickDisplayName(ME));
}

/* ---------- auth me ---------- */
async function loadMe(){
  try{
    const r = await api("/api/auth/me?ts="+Date.now());
    const u = r?.user ?? r?.item ?? r?.me ?? null;
    if(!u){
      ME = null;
      document.getElementById("me").textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ï¼‰";
      return;
    }
    ME = u;

    const dn = pickDisplayName(u);
    const role = pickRole(u);
    const un = u.username ?? "";
    document.getElementById("me").textContent =
      `ãƒ­ã‚°ã‚¤ãƒ³ï¼š${dn || un || "?"}ï¼ˆ${role || "?"}ï¼‰`;
  }catch(e){
    ME = null;
    document.getElementById("me").textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ï¼‰";
  }
}

/* ---------- render ---------- */
function likeSvg(filled){
  // è½»é‡ YouTube-like thumb icon
  if(filled){
    return `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path fill="currentColor" d="M2 21h4V9H2v12zm20-11c0-1.1-.9-2-2-2h-6.3l1-4.6.03-.32c0-.41-.17-.79-.44-1.06L13 1 7.6 6.4C7.22 6.78 7 7.3 7 7.83V19c0 1.1.9 2 2 2h8c.82 0 1.54-.5 1.84-1.22l2.02-4.71c.09-.23.14-.47.14-.72V10z"/>
    </svg>`;
  }
  return `<svg viewBox="0 0 24 24" aria-hidden="true">
    <path fill="currentColor" d="M2 21h4V9H2v12zM22 10c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L13 1 7.59 6.41C7.22 6.78 7 7.3 7 7.83V19c0 1.1.9 2 2 2h8c.82 0 1.54-.5 1.84-1.22l2.02-4.71c.09-.23.14-.47.14-.72V10zm-2 4.06L17.98 19H9V7.83l3.34-3.34L11.12 10H20v4.06z"/>
  </svg>`;
}

function renderPost(p){
  const div=document.createElement("div");
  div.className="post";
  div.dataset.id = String(p.id);

  const likeCount = fmtCount(p.like_count ?? 0);
  const commentCount = fmtCount(p.comment_count ?? 0);

  const showEdit = canEditPost(p);

  div.innerHTML = `
    <div class="meta">
      <span class="badge">ğŸ‘¤ ${esc(p.name||"?")}</span>
      <span class="badge">ğŸ« ${esc(p.class_name||"-")}</span>
      <span class="badge">ğŸ“… ${esc(p.lesson_date||"-")}</span>
      <span class="badge">ğŸ•’ ${esc(p.created_at||"-")}</span>
    </div>

    <div class="topic">${esc(p.topic||"")}</div>

    <ol>
      ${(p.line1||"").trim()?`<li>${esc(p.line1)}</li>`:""}
      ${(p.line2||"").trim()?`<li>${esc(p.line2)}</li>`:""}
      ${(p.line3||"").trim()?`<li>${esc(p.line3)}</li>`:""}
    </ol>

    <div class="actions">
      <!-- âœ… YouTube-like -->
      <button class="iconBtn btnLikeToggle" data-liked="0" title="ã„ã„ã­">
        <span class="ico">${likeSvg(false)}</span>
        <span class="num likeCount">${likeCount}</span>
      </button>

      <button class="btn ghost btnToggle">ã‚³ãƒ¡ãƒ³ãƒˆ</button>
      <span class="muted">ğŸ’¬ <span class="commentCount">${commentCount}</span></span>

      ${showEdit ? `<button class="btn gray btnEdit">ä¿®æ­£</button>` : ``}

      <span class="muted" style="margin-left:auto">${p.last_commented_at ? ("æœ€çµ‚ã‚³ãƒ¡ãƒ³ãƒˆ: "+esc(p.last_commented_at)) : ""}</span>
    </div>

    <div class="comments">
      <div class="muted cstatus">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      <div class="clist"></div>

      <!-- âœ… è°éƒ½å¯ä»¥è¯„è®ºï¼ˆåªè¦ç™»å½•ï¼‰ -->
      <div class="hr"></div>
      <div class="muted">ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ </div>
      <textarea class="cbody" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ã¦ãã ã•ã„"></textarea>
      <div class="inline">
        <button class="btn primary btnAdd">ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿</button>
      </div>

      <div class="err cerr" style="display:none"></div>
    </div>
  `;

  wire(div, p);
  return div;
}

function renderCommentItem(c){
  // å…¼å®¹æ—§å­—æ®µ teacher_name
  const who = c.user_name ?? c.teacher_name ?? c.author ?? "?";
  return `
    <div style="padding:10px 0;border-top:1px solid #eef2f7">
      <div class="muted" style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div>ğŸ§‘ ${esc(who)} ï½œ ğŸ•’ ${esc(c.created_at||"-")}${c.updated_at ? (" ï½œ âœï¸ "+esc(c.updated_at)) : ""}</div>
      </div>
      <div style="white-space:pre-wrap;line-height:1.55;margin-top:6px">${esc(c.body||"")}</div>
    </div>
  `;
}

/* ---------- like status loader (concurrency) ---------- */
async function loadLikeStatusForVisible(){
  const nodes = Array.from(document.querySelectorAll(".post"));
  const tasks = nodes.map(n=> async ()=>{
    const id = n.dataset.id;
    const btn = n.querySelector(".btnLikeToggle");
    const countEl = n.querySelector(".likeCount");
    if(!btn) return;

    try{
      const r = await api(`/api/posts/${encodeURIComponent(id)}/like?ts=`+Date.now());
      const liked = !!r.liked;
      const c = (r.like_count ?? r.likeCount ?? countEl.textContent);
      setLiked(btn, liked);
      countEl.textContent = String(c);
    }catch(e){
      // ä¸è¦å¼¹çª—è½°ç‚¸ï¼Œåªä¿æŒé»˜è®¤çŠ¶æ€
      // console.warn(e);
    }
  });

  // ç®€å•å¹¶å‘æ§åˆ¶
  const limit = 6;
  let idx = 0;
  async function worker(){
    while(idx < tasks.length){
      const i = idx++;
      await tasks[i]();
    }
  }
  await Promise.all(Array.from({length:Math.min(limit,tasks.length)}, worker));
}

function setLiked(btn, liked){
  btn.dataset.liked = liked ? "1" : "0";
  btn.classList.toggle("on", liked);
  const ico = btn.querySelector(".ico");
  if(ico) ico.innerHTML = likeSvg(liked);
}

/* ---------- actions ---------- */
function wire(div,p){
  const id = Number(p.id);

  const btnEdit = div.querySelector(".btnEdit");
  if(btnEdit){
    btnEdit.onclick = () => location.href = `/posts_modify.html?id=${encodeURIComponent(id)}`;
  }

  // comments
  const box = div.querySelector(".comments");
  const btnToggle = div.querySelector(".btnToggle");
  const cstatus = div.querySelector(".cstatus");
  const clist = div.querySelector(".clist");
  const cerr = div.querySelector(".cerr");

  btnToggle.onclick = async () => {
    const shown = box.style.display !== "none";
    if(shown){ box.style.display="none"; return; }
    box.style.display="";
    cerr.style.display="none"; cerr.textContent="";
    cstatus.textContent="èª­ã¿è¾¼ã¿ä¸­â€¦";
    clist.innerHTML="";
    try{
      const data = await api(`/api/posts/${id}/comments?ts=${Date.now()}`);
      const items = data.items || data.comments || [];
      cstatus.textContent = items.length ? `ã‚³ãƒ¡ãƒ³ãƒˆï¼š${items.length}ä»¶` : "ã‚³ãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚";
      clist.innerHTML = items.map(renderCommentItem).join("");
    }catch(e){
      cstatus.textContent="ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼";
      cerr.style.display=""; cerr.textContent=String(e.message||e);
    }
  };

  // like toggle (YouTube-like)
  const btnLikeToggle = div.querySelector(".btnLikeToggle");
  const likeCountEl = div.querySelector(".likeCount");
  if(btnLikeToggle){
    btnLikeToggle.onclick = async ()=>{
      if(!ME){
        alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
        location.replace("/login?ts="+Date.now());
        return;
      }

      btnLikeToggle.disabled = true;
      try{
        const likedNow = btnLikeToggle.dataset.liked === "1";
        if(!likedNow){
          const r = await api(`/api/posts/${id}/like`, { method:"POST" });
          const c = r.like_count ?? r.likeCount ?? likeCountEl.textContent;
          likeCountEl.textContent = String(c);
          setLiked(btnLikeToggle, true);
        }else{
          const r = await api(`/api/posts/${id}/like`, { method:"DELETE" });
          const c = r.like_count ?? r.likeCount ?? likeCountEl.textContent;
          likeCountEl.textContent = String(c);
          setLiked(btnLikeToggle, false);
        }
      }catch(e){
        alert(String(e.message||e));
      }finally{
        btnLikeToggle.disabled = false;
      }
    };
  }

  // add comment (any logged-in user)
  const btnAdd = div.querySelector(".btnAdd");
  if(btnAdd){
    btnAdd.onclick = async () => {
      if(!ME){
        alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
        location.replace("/login?ts="+Date.now());
        return;
      }
      const ta = div.querySelector(".cbody");
      const body = (ta.value||"").trim();
      if(!body){ alert("ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ãŒç©ºã§ã™"); return; }
      try{
        await api(`/api/posts/${id}/comments`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ body })
        });
        ta.value="";
        // reload comments quickly
        btnToggle.click();
        btnToggle.click();
        // update comment count UI optimistically
        const commentCountEl = div.querySelector(".commentCount");
        commentCountEl.textContent = String(Number(commentCountEl.textContent||0)+1);
      }catch(e){
        alert(String(e.message||e));
      }
    };
  }
}

/* ---------- filter ---------- */
const $fName  = document.getElementById("fName");
const $fClass = document.getElementById("fClass");
const $fDate  = document.getElementById("fDate");
const $fTopic = document.getElementById("fTopic");
const $filterStatus = document.getElementById("filterStatus");

function uniqSorted(arr){
  const s = new Set();
  for(const v of arr){
    const t = String(v ?? "").trim();
    if(t) s.add(t);
  }
  return Array.from(s).sort((a,b)=>a.localeCompare(b,"ja"));
}

function rebuildFilterOptions(items){
  const keep = { name:$fName.value, cls:$fClass.value, date:$fDate.value, topic:$fTopic.value };

  const names  = uniqSorted(items.map(x=>x.name));
  const clses  = uniqSorted(items.map(x=>x.class_name));
  const dates  = uniqSorted(items.map(x=>x.lesson_date)).sort((a,b)=>String(b).localeCompare(String(a)));
  const topics = uniqSorted(items.map(x=>x.topic));

  function fill(sel, values, keepVal){
    sel.innerHTML = `<option value="">ã™ã¹ã¦</option>` + values.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join("");
    if(keepVal && values.includes(keepVal)) sel.value = keepVal;
    else sel.value = "";
  }
  fill($fName, names, keep.name);
  fill($fClass, clses, keep.cls);
  fill($fDate, dates, keep.date);
  fill($fTopic, topics, keep.topic);
}

function renderList(items){
  const list=document.getElementById("list");
  list.innerHTML="";
  items.forEach(p=>list.appendChild(renderPost(p)));
}

function applyFilters(){
  const vName  = $fName.value;
  const vClass = $fClass.value;
  const vDate  = $fDate.value;
  const vTopic = $fTopic.value;

  VIEW_ITEMS = ALL_ITEMS.filter(p=>{
    if(vName  && String(p.name||"").trim() !== vName) return false;
    if(vClass && String(p.class_name||"").trim() !== vClass) return false;
    if(vDate  && String(p.lesson_date||"").trim() !== vDate) return false;
    if(vTopic && String(p.topic||"").trim() !== vTopic) return false;
    return true;
  });

  renderList(VIEW_ITEMS);
  $filterStatus.textContent = `è¡¨ç¤ºï¼š${VIEW_ITEMS.length} / ${ALL_ITEMS.length}`;

  // âœ… åˆå§‹åŒ–æ¯æ¡çš„â€œæˆ‘æ˜¯å¦å·²ç‚¹èµâ€
  loadLikeStatusForVisible();
}

function clearFilters(){
  $fName.value = "";
  $fClass.value = "";
  $fDate.value = "";
  $fTopic.value = "";
  applyFilters();
}

/* ---------- load list ---------- */
async function refresh(){
  document.getElementById("status").textContent="èª­ã¿è¾¼ã¿ä¸­â€¦";
  const list=document.getElementById("list");
  list.innerHTML="";
  try{
    const data = await api("/api/posts?limit=50&ts="+Date.now());
    ALL_ITEMS = data.items || [];
    document.getElementById("status").textContent = `ä»¶æ•°ï¼š${ALL_ITEMS.length}`;

    rebuildFilterOptions(ALL_ITEMS);
    applyFilters();
  }catch(e){
    document.getElementById("status").textContent="ã‚¨ãƒ©ãƒ¼: "+String(e.message||e);
  }
}

document.getElementById("btnRefresh").onclick = refresh;
document.getElementById("btnNew").onclick = () => location.href = "/posts_new.html";
document.getElementById("btnClear").onclick = clearFilters;

[$fName,$fClass,$fDate,$fTopic].forEach(sel=> sel.addEventListener("change", applyFilters));

(async () => {
  await loadMe();
  await refresh();
})();
</script>
</body>
</html>
