<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è³ªå•æ²ç¤ºæ¿</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;margin:0;background:#f5f7fb}
    header{background:#0b5ed7;color:#fff;padding:24px 16px}
    .wrap{max-width:1100px;margin:0 auto}
    a{color:#fff;text-decoration:none;font-weight:700}
    main{padding:18px 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:#fff;border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    label{display:block;font-size:12px;color:#666;margin:10px 0 6px}
    input,textarea{width:100%;padding:10px 12px;border:1px solid #e6e9f2;border-radius:12px;font-size:14px}
    textarea{min-height:80px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .btn{border:0;border-radius:12px;padding:10px 14px;background:#0b5ed7;color:#fff;font-weight:800;cursor:pointer}
    .btn.gray{background:#495057}
    .item{border:1px solid #eef1f7;border-radius:14px;padding:12px;margin-top:10px}
    .meta{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
    .pill{background:#f1f3f7;border-radius:999px;padding:6px 10px;font-size:12px;color:#333}
    .muted{color:#666}
    pre{background:#0b1020;color:#dfe7ff;padding:10px;border-radius:12px;overflow:auto}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div>
        <div style="opacity:.95"><a href="/index.html">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼</a></div>
        <h1 style="margin:6px 0 0">è³ªå•æ²ç¤ºæ¿</h1>
      </div>
      <div class="muted" style="color:#dbe7ff">/api/questions</div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="grid">
        <div class="card">
          <h2 style="margin:0 0 8px">è³ªå•ã‚’æŠ•ç¨¿</h2>

          <label>åå‰</label>
          <input id="name" value="æ¥Šæ—»" />

          <label>æˆæ¥­æ—¥ï¼ˆYYYY-MM-DDï¼‰</label>
          <input id="lesson_date" />

          <label>ãƒ†ãƒ¼ãƒ</label>
          <input id="topic" placeholder="ä¾‹ï¼‰SQL" />

          <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input id="title" placeholder="ä¾‹ï¼‰LEFT JOIN ã¨ WHERE ã®é•ã„" />

          <label>æœ¬æ–‡</label>
          <textarea id="body" placeholder="è³ªå•å†…å®¹"></textarea>

          <div class="row" style="margin-top:12px">
            <button class="btn gray" id="btnFill">ã‚µãƒ³ãƒ—ãƒ«</button>
            <button class="btn" id="btnPost">é€ä¿¡</button>
          </div>

          <pre id="out" style="margin-top:12px">{}</pre>
        </div>

        <div class="card">
          <div class="row">
            <h2 style="margin:0">è³ªå•ä¸€è¦§</h2>
            <button class="btn" id="btnRefresh">æ›´æ–°</button>
          </div>
          <div class="row" style="margin-top:8px">
            <span class="muted"><span id="count">0</span>ä»¶</span>
            <span class="muted">ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã¸</span>
          </div>
          <div id="list"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    function todayISO(){
      const d=new Date(); const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,"0");
      const dd=String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    }
    document.getElementById("lesson_date").value = todayISO();

    async function api(path, opt={}){
      const res = await fetch(path, opt);
      const text = await res.text();
      let data; try{ data = JSON.parse(text);}catch{ data = text;}
      if(!res.ok) throw new Error("HTTP "+res.status+" "+text);
      return data;
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function renderItem(q){
      const el=document.createElement("div");
      el.className="item";
      el.style.cursor="pointer";
      el.addEventListener("click", ()=> location.href = `/question.html?id=${encodeURIComponent(q.id)}`);
      const meta=document.createElement("div");
      meta.className="meta";
      meta.innerHTML = `
        <span class="pill">#${escapeHtml(q.id)}</span>
        <span class="pill">ğŸ‘¤ ${escapeHtml(q.name ?? "")}</span>
        <span class="pill">ğŸ§© ${escapeHtml(q.topic ?? "")}</span>
        <span class="pill">ğŸ—“ ${escapeHtml(q.lesson_date ?? "")}</span>
        <span class="pill">${q.is_done ? "âœ… è§£æ±º" : "ğŸŸ¡ æœªè§£æ±º"}</span>
      `;
      const title=document.createElement("div");
      title.innerHTML = `<b>${escapeHtml(q.title ?? "")}</b>`;
      const body=document.createElement("div");
      body.className="muted";
      body.style.marginTop="6px";
      body.textContent = (q.body ?? "").slice(0,120);
      el.appendChild(meta); el.appendChild(title); el.appendChild(body);
      return el;
    }

    async function refresh(){
      const data = await api("/api/questions?limit=50");
      const items = data.items || [];
      document.getElementById("count").textContent = items.length;
      const list=document.getElementById("list");
      list.innerHTML="";
      items.forEach(q=> list.appendChild(renderItem(q)));
    }

    document.getElementById("btnFill").addEventListener("click", ()=>{
      document.getElementById("topic").value = "SQL";
      document.getElementById("title").value = "LEFT JOIN ã¨ WHERE ã®é•ã„ãŒåˆ†ã‹ã‚Šã¾ã›ã‚“";
      document.getElementById("body").value = "WHEREã«æ¡ä»¶ã‚’æ›¸ãã¨å¤–éƒ¨çµåˆã®çµæœãŒå¤‰ã‚ã‚‹ç†ç”±ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚";
    });

    document.getElementById("btnPost").addEventListener("click", async ()=>{
      const payload = {
        name: document.getElementById("name").value.trim(),
        lesson_date: document.getElementById("lesson_date").value.trim(),
        topic: document.getElementById("topic").value.trim(),
        title: document.getElementById("title").value.trim(),
        body: document.getElementById("body").value.trim(),
      };
      const out=document.getElementById("out");
      out.textContent="sending...";
      try{
        const data = await api("/api/questions",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        out.textContent = JSON.stringify(data,null,2);
        await refresh();
      }catch(e){
        out.textContent = String(e);
      }
    });

    document.getElementById("btnRefresh").addEventListener("click", refresh);
    refresh();
  </script>
</body>
</html>
